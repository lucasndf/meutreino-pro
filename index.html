<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MeuTreino PRO</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #fafafa;
  --panel:#ffffff;
  --border:#e6e6e6;
  --text:#111;
  --sub:#555;
  --muted:#f3f3f3;
  --brand:#009c3b;
  --brand-dark:#026a29;
  --danger:#e54848;
}

*{box-sizing:border-box}
body{
  margin:0;width:100%;height:100%;
  font-family:'Inter',sans-serif;
  background:var(--bg);color:var(--text);
}

/* LOGIN LAYOUT */
.wrap{
  min-height:100vh;
  display:flex;justify-content:center;align-items:center;padding:16px;
}
.card{
  width:100%;max-width:420px;
  background:var(--panel);
  border-radius:16px;
  border:1px solid var(--border);
  padding:26px;
}
.brand{
  display:flex;align-items:center;gap:12px;font-size:20px;font-weight:bold;
}
.brand-logo{
  width:40px;height:40px;
  background:var(--brand);
  display:flex;align-items:center;justify-content:center;
  border-radius:8px;color:#fff;font-size:22px;
}
.pro{color:var(--brand-dark);font-weight:700}
.title{font-size:20px;margin:12px 0 6px}
.subtitle{font-size:14px;color:var(--sub);margin-bottom:14px}
.hidden{display:none !important}

.field{display:flex;flex-direction:column;margin-bottom:14px}
input,select,textarea{
  padding:12px;border-radius:10px;font-size:15px;
  border:1px solid var(--border);background:var(--muted);
}
.btn{
  width:100%;padding:12px;margin-top:2px;
  border:none;border-radius:10px;
  font-weight:600;cursor:pointer;
}
.btn.primary{background:var(--brand);color:#fff}
.btn.google{background:#fff;border:1px solid #ccc;color:#333}
.btn.ghost{background:var(--panel);border:1px solid var(--border);color:var(--text)}

.linkbar{display:flex;justify-content:space-between;margin-top:10px}
.link{border:none;background:none;color:var(--brand-dark);font-size:14px;cursor:pointer}

/* ALERT */
.alert{
  display:none;padding:10px;font-size:14px;margin-bottom:12px;border-radius:8px;background:#ffd8d8;color:#8a0000;
}
.alert.ok{background:#daf5d8;color:#084d19}

/* APP AREA */
.app{width:100%;max-width:1100px;margin:auto;padding:20px}
.topbar{
  display:grid;grid-template-columns:1fr auto auto;gap:12px;
  align-items:center;margin-bottom:18px;
}
.pill{
  padding:6px 12px;background:var(--muted);
  border-radius:12px;border:1px solid var(--border);font-size:14px;
}
.grid{display:grid;gap:16px}
@media(min-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}

.card-student{
  background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px;
}
.badge{
  background:var(--muted);
  padding:6px 10px;border-radius:999px;font-size:12px;color:var(--sub);
}
.actions{display:flex;gap:8px}
.btn-sm{
  padding:8px 10px;border-radius:8px;font-size:13px;cursor:pointer;
  border:1px solid var(--border);background:var(--muted);
}
.btn-sm.brand{background:var(--brand);color:#fff;border:none}
.btn-sm.danger{background:var(--danger);color:#fff;border:none}

/* FAB */
.fab{
  position:fixed;bottom:28px;right:28px;
  width:56px;height:56px;border-radius:50%;
  font-size:36px;background:var(--brand);color:#fff;border:none;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}

/* MODAL */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:flex;align-items:center;justify-content:center;
}
.modal{
  width:90%;max-width:380px;background:var(--panel);
  padding:22px;border-radius:16px;
  border:1px solid var(--border);
}
.modal h2{margin:0 0 14px}

</style>
</head>
<body>

<main class="wrap">

<!-- ‚úÖ LOGIN -->
<section id="auth-card" class="card">
  <div class="brand">
    <div class="brand-logo">üèãÔ∏è</div>
    MeuTreino <span class="pro">PRO</span>
  </div>

  <h2 class="title" id="view-title">Entrar</h2>
  <p class="subtitle" id="view-sub">Gerencie seus alunos facilmente.</p>

  <div id="alert" class="alert"></div>

  <form id="form-login">
    <div class="field"><label>Email</label><input id="login-email" type="email" required /></div>
    <div class="field"><label>Senha</label><input id="login-pass" type="password" required /></div>
    <button class="btn primary">Entrar</button>
  </form>

  <form id="form-signup" class="hidden">
    <div class="field"><label>Nome completo</label><input id="su-name" required /></div>
    <div class="field"><label>Email</label><input id="su-email" type="email" required /></div>
    <div class="field"><label>Senha (6+)</label><input id="su-pass" type="password" minlength="6" required /></div>
    <button class="btn primary">Criar conta</button>
  </form>

  <form id="form-reset" class="hidden">
    <div class="field"><label>Email cadastrado</label><input id="rs-email" type="email" required /></div>
    <button class="btn primary">Enviar link</button>
  </form>

  <div class="hr"></div>
  <button id="btn-google" class="btn google">Entrar com Google</button>

  <div class="linkbar">
    <button class="link" id="go-signup">Criar conta</button>
    <button class="link" id="go-reset">Esqueci a senha</button>
  </div>
  <div class="linkbar">
    <button class="link hidden" id="go-login">Voltar login</button>
  </div>
</section>

<!-- ‚úÖ APP -->
<section id="app" class="app hidden">
  <div class="topbar">
    <strong>Meus Alunos</strong>
    <input id="search" class="search" type="text" placeholder="Pesquisar por nome..." />
    <div class="tools">
      <span class="pill" id="plan-pill">Plano: Free (5)</span>
      <span class="pill" id="user-pill">...</span>
      <button id="btn-logout" class="btn ghost" style="width:auto">Sair</button>
    </div>
  </div>

  <div id="students-list" class="grid"></div>
  <button id="btn-add" class="fab">+</button>
</section>

<!-- ‚úÖ MODAL ALUNO -->
<div id="modal-bg" class="modal-bg hidden">
  <div class="modal">
    <h2 id="modal-title">Novo Aluno</h2>
    <form id="form-student">
      <input type="hidden" id="st-id">
      <div class="field"><label>Nome</label><input id="st-name" required /></div>
      <div class="field"><label>WhatsApp</label><input id="st-phone" /></div>
      <div class="field"><label>Objetivo</label>
        <select id="st-goal"><option>Hipertrofia</option><option>Emagrecimento</option><option>Resist√™ncia</option></select>
      </div>
      <div class="field"><label>N√≠vel</label>
        <select id="st-level"><option>Iniciante</option><option>Intermedi√°rio</option><option>Avan√ßado</option></select>
      </div>
      <div class="field"><label>Observa√ß√µes</label><textarea id="st-notes" rows="3"></textarea></div>
      <button class="btn primary" type="submit">Salvar</button>
      <button class="btn ghost" type="button" id="btn-cancel">Cancelar</button>
    </form>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  GoogleAuthProvider, signInWithPopup, signOut,
  updateProfile, sendPasswordResetEmail, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, onSnapshot, query, where,
  serverTimestamp, doc, deleteDoc, updateDoc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

// ‚úÖ CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyBsPf40matUV8So60OHb0h4oRwMRWaB0ho",
  authDomain: "acdm-70082.firebaseapp.com",
  projectId: "acdm-70082",
  storageBucket: "acdm-70082.firebasestorage.app",
  messagingSenderId: "236961358499",
  appId: "1:236961358499:web:40b7391c4c9b3405ff1516"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ‚úÖ UI HELPERS
const $ = (id)=>document.getElementById(id);
function showAlert(msg, ok=false){
  const box = $("alert");
  box.textContent = msg;
  box.style.display = "block";
  box.classList.toggle("ok", ok);
  clearTimeout(showAlert._t);
  showAlert._t = setTimeout(()=> box.style.display="none", 3500);
}
function switchView(view){
  ["form-login","form-signup","form-reset"].forEach(id => $(id).classList.add("hidden"));
  $("go-login").classList.remove("hidden");
  if(view==="signup"){
    $("form-signup").classList.remove("hidden");
    $("view-title").textContent = "Criar conta";
    $("view-sub").textContent = "Cadastre-se e comece!";
  } else if(view==="reset"){
    $("form-reset").classList.remove("hidden");
    $("view-title").textContent = "Recuperar senha";
    $("view-sub").textContent = "Receba um link no email";
  } else {
    $("form-login").classList.remove("hidden");
    $("view-title").textContent = "Entrar";
    $("view-sub").textContent = "Gerencie seus alunos";
    $("go-login").classList.add("hidden");
  }
}

// ‚úÖ TROCA DE FORMUL√ÅRIO
$("go-signup").onclick = ()=>switchView("signup");
$("go-reset").onclick = ()=>switchView("reset");
$("go-login").onclick = ()=>switchView("login");

// ‚úÖ LOGIN EMAIL
$("form-login").onsubmit = async(e)=>{
  e.preventDefault();
  try{
    await signInWithEmailAndPassword(auth,
      $("login-email").value,
      $("login-pass").value
    );
  }catch(err){
    showAlert("Erro: " + err.message);
  }
};

// ‚úÖ CADASTRO
$("form-signup").onsubmit = async(e)=>{
  e.preventDefault();
  try{
    const cred = await createUserWithEmailAndPassword(auth,
      $("su-email").value,
      $("su-pass").value
    );
    await updateProfile(cred.user, { displayName: $("su-name").value });

    await setDoc(doc(db,"users",cred.user.uid), {
      plan:"free", limit:5,
      name:$("su-name").value,
      email:cred.user.email,
      createdAt: serverTimestamp()
    });

    showAlert("Conta criada com sucesso!", true);
  }catch(err){
    showAlert("Erro: " + err.message);
  }
};

// ‚úÖ RECUPERA√á√ÉO DE SENHA
$("form-reset").onsubmit = async(e)=>{
  e.preventDefault();
  try{
    await sendPasswordResetEmail(auth, $("rs-email").value);
    showAlert("Email enviado!", true);
    switchView("login");
  }catch(err){ showAlert(err.message); }
};

// ‚úÖ LOGIN GOOGLE
$("btn-google").onclick = async()=>{
  try{
    const cred = await signInWithPopup(auth, new GoogleAuthProvider());
    const ref = doc(db,"users",cred.user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, {
        plan:"free", limit:5,
        email:cred.user.email,
        name:cred.user.displayName,
        createdAt: serverTimestamp()
      });
    }
  }catch(err){
    showAlert("Erro: " + err.message);
  }
};

// ‚úÖ LOGOUT
$("btn-logout").onclick = ()=>signOut(auth);

// ‚úÖ FUN√á√ÉO WHATSAPP
const phoneToWhatsApp = (p)=>{
  const num = (p||"").replace(/\D/g,"");
  return num ? `https://wa.me/55${num}` : null;
};

// ‚úÖ RENDER CARDS
function renderStudent(st){
  const item = document.createElement("div");
  item.className = "card-student";
  item.innerHTML = `
    <strong>${st.name}</strong>
    <span class="badge">üéØ ${st.goal}</span>
    <span class="badge">üìå ${st.level}</span>
    ${st.notes ? `<small>${st.notes}</small>` : ""}
    ${
      st.phone ?
      `<a href="${phoneToWhatsApp(st.phone)}" target="_blank" class="btn-sm brand">WhatsApp</a>` :
      `<span class="badge">Sem telefone</span>`
    }
    <div class="actions">
      <button class="btn-sm" data-edit>Editar</button>
      <button class="btn-sm danger" data-del>Excluir</button>
    </div>`;
  
  // Editar
  item.querySelector("[data-edit]").onclick = ()=>{
    $("modal-title").textContent = "Editar aluno";
    $("st-id").value = st.id;
    $("st-name").value = st.name;
    $("st-phone").value = st.phone;
    $("st-goal").value = st.goal;
    $("st-level").value = st.level;
    $("st-notes").value = st.notes;
    $("modal-bg").classList.remove("hidden");
  };

  // Excluir
  item.querySelector("[data-del]").onclick = async()=>{
    if(confirm("Excluir aluno?")){
      await deleteDoc(doc(db,"students",st.id));
    }
  };

  return item;
}

// ‚úÖ EXIBE LISTA
function renderList(list){
  const wrap = $("students-list");
  wrap.innerHTML = "";
  const term = $("search").value.toLowerCase();
  list
    .filter(s => s.name.toLowerCase().includes(term))
    .forEach(s => wrap.appendChild(renderStudent(s)));
}

// ‚úÖ ESTADO LOGIN
let unsub = null;
let currentUser = null;
let currentPlan = { plan:"free", limit:5 };
async function start(user){
  currentUser = user;
  $("auth-card").classList.add("hidden");
  $("app").classList.remove("hidden");
  $("user-pill").textContent = user.email;

  const uref = doc(db,"users",user.uid);
  const usnap = await getDoc(uref);
  if(usnap.exists()) currentPlan = usnap.data();

  $("plan-pill").textContent =
    currentPlan.plan === "pro"
    ? "Plano: PRO (ilimitado)"
    : `Plano: Free (${currentPlan.limit})`;

  if(unsub) unsub();
  unsub = onSnapshot(
    query(collection(db,"students"), where("ownerId","==",user.uid)),
    snap=>{
      const arr=[];
      snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
      renderList(arr);
      start._count = arr.length;
    }
  );
}

// ‚úÖ FIREBASE MONITOR
onAuthStateChanged(auth,(user)=>{
  if(user) start(user);
  else{
    $("app").classList.add("hidden");
    $("auth-card").classList.remove("hidden");
    if(unsub) unsub();
  }
});

// ‚úÖ PESQUISA
$("search").oninput = ()=> renderList(start._list||[]);

// ‚úÖ ABRIR MODAL
$("btn-add").onclick = ()=>{
  if(currentPlan.plan!=="pro" && start._count >= currentPlan.limit){
    alert("Limite do Plano Free atingido!");
    return;
  }
  $("modal-title").textContent = "Novo aluno";
  $("form-student").reset();
  $("st-id").value = "";
  $("modal-bg").classList.remove("hidden");
};

// ‚úÖ CANCELAR MODAL
$("btn-cancel").onclick = ()=> $("modal-bg").classList.add("hidden");

// ‚úÖ SALVAR ALUNO
$("form-student").onsubmit = async(e)=>{
  e.preventDefault();
  const id = $("st-id").value;
  const data = {
    ownerId: currentUser.uid,
    name: $("st-name").value,
    phone: $("st-phone").value,
    goal: $("st-goal").value,
    level: $("st-level").value,
    notes: $("st-notes").value,
    updatedAt: serverTimestamp()
  };
  try{
    if(id){
      await updateDoc(doc(db,"students",id), data);
      showAlert("Aluno atualizado ‚úÖ",true);
    }else{
      data.createdAt = serverTimestamp();
      await addDoc(collection(db,"students"), data);
      showAlert("Aluno cadastrado ‚úÖ",true);
    }
    $("modal-bg").classList.add("hidden");
  }catch(err){
    showAlert("Erro: " + err.message);
  }
};

</script>
</body>
</html>
