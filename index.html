<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MeuTreino PRO</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#fafafa; --panel:#fff; --border:#e6e6e6; --text:#111; --sub:#555; --muted:#f3f3f3;
  --brand:#009c3b; --brand-dark:#026a29; --danger:#e54848; --ok:#18a34a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  overscroll-behavior-y:none; /* evita atualizar arrastando pra cima (pull-to-refresh) */
}
.hidden{display:none!important}

/* ------------ Layouts ------------- */
.wrap{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:16px;
}
.card{
  width:100%;
  max-width:420px;
  background:var(--panel);
  border-radius:16px;
  border:1px solid var(--border);
  padding:26px;
}
.brand{display:flex;align-items:center;gap:12px;font-size:20px;font-weight:700}
.brand-logo{
  width:40px;height:40px;display:flex;align-items:center;justify-content:center;
  background:var(--brand);color:#fff;border-radius:8px;font-size:22px
}
.pro{color:var(--brand-dark);font-weight:800}
.title{font-size:20px;margin:12px 0 6px}
.subtitle{font-size:14px;color:var(--sub);margin-bottom:14px}

/* ------------ Form ------------- */
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:14px}
input,select,textarea{
  padding:12px;border-radius:10px;font-size:15px;
  border:1px solid var(--border);background:var(--muted)
}
textarea{resize:vertical}
.btn{
  width:100%;padding:12px;border:none;border-radius:10px;
  font-weight:600;cursor:pointer
}
.btn.primary{background:var(--brand);color:#fff}
.btn.google{background:#fff;border:1px solid #ccc;color:#333}
.btn.ghost{background:var(--panel);border:1px solid var(--border);color:var(--text)}
.linkbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;margin-top:10px}
.link{border:none;background:none;color:var(--brand-dark);font-size:14px;cursor:pointer}

/* Alert */
.alert{
  display:none;padding:10px;font-size:14px;margin-bottom:12px;
  border-radius:8px;background:#ffd8d8;color:#8a0000;white-space:pre-line
}
.alert.ok{background:#daf5d8;color:#084d19}

/* Password */
.password-wrapper{position:relative;display:flex;align-items:center}
.password-wrapper input{flex:1;padding-right:40px}
.toggle-pass{
  position:absolute;right:10px;top:50%;transform:translateY(-50%);
  width:28px;height:28px;border-radius:999px;border:none;background:transparent;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.toggle-pass-icon{
  width:18px;height:18px;border-radius:999px;border:1px solid #b3b3b3;position:relative;
}
.toggle-pass-icon::before{
  content:"";position:absolute;inset:4px;border-radius:999px;border:1px solid #b3b3b3;
}
.toggle-pass-icon::after{
  content:"";position:absolute;width:12px;height:2px;border-radius:999px;background:#b3b3b3;
  transform:rotate(45deg);opacity:0;
}
.toggle-pass--on .toggle-pass-icon{border-color:var(--brand-dark)}
.toggle-pass--on .toggle-pass-icon::before{border-color:var(--brand-dark)}
.toggle-pass--on .toggle-pass-icon::after{opacity:1;background:var(--brand-dark)}
.caps-hint{margin-top:4px;font-size:12px;color:#b45309;display:none}

/* ------------ App ------------- */
.app,.view,.week-view{
  width:100%;max-width:1100px;margin:auto;padding:20px
}
.topbar{
  display:grid;grid-template-columns:1fr auto auto;
  gap:12px;align-items:center;margin-bottom:18px
}
.tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{
  padding:6px 12px;background:var(--muted);
  border-radius:12px;border:1px solid var(--border);font-size:14px
}
.search{max-width:320px}
.grid{display:grid;gap:16px}
@media(min-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}

.card-student{
  background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px
}
.badge{
  background:var(--muted);padding:6px 10px;border-radius:999px;
  font-size:12px;color:var(--sub)
}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn-sm{
  padding:8px 10px;border-radius:8px;font-size:13px;
  cursor:pointer;border:1px solid var(--border);background:var(--muted)
}
.btn-sm.brand{background:var(--brand);color:#fff;border:none}
.btn-sm.danger{background:var(--danger);color:#fff;border:none}
.btn-xs{
  padding:6px 8px;border-radius:8px;font-size:12px;
  border:1px solid var(--border);background:var(--muted);cursor:pointer
}

/* FAB */
.fab{
  position:fixed;right:22px;bottom:22px;width:54px;height:54px;
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  background:var(--brand);color:#fff;border:none;font-size:26px;
  box-shadow:0 10px 20px rgba(0,0,0,.15);cursor:pointer
}

/* Views */
.view-header{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;margin-bottom:12px
}
.back{
  padding:8px 12px;border-radius:8px;background:var(--panel);
  border:1px solid var(--border);cursor:pointer
}
.helper{
  padding:14px;background:#fff7d1;border:1px dashed #e3c54b;
  border-radius:12px;color:#5c4a00
}

/* Days / Exercises (personal) */
.days-grid{display:grid;gap:12px}
@media(min-width:700px){.days-grid{grid-template-columns:repeat(2,1fr)}}
.day-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;padding:14px
}
.day-top{
  display:flex;justify-content:space-between;
  align-items:center;font-weight:700;margin-bottom:8px
}
.day-actions{display:flex;gap:8px}
.list{display:flex;flex-direction:column;gap:12px}
.ex-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px
}
.ex-top{display:flex;justify-content:space-between;gap:10px}
.ex-name{font-weight:700}
.ex-line{display:flex;flex-wrap:wrap;gap:8px}
.ex-chip{
  background:var(--muted);border:1px solid var(--border);
  padding:4px 8px;border-radius:999px;font-size:12px
}

/* Week (aluno) ‚Äì tela de ROTINAS */
.week-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:16px
}
.week-day-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:14px;margin-bottom:12px
}
.week-day-title{font-weight:700;margin-bottom:4px}
.week-day-sub{font-size:14px;color:var(--sub);margin-bottom:6px}

/* Timer gen√©rico (usado na tela de treino do dia) */
.week-timer{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:16px;padding:10px 14px;border-radius:12px;
  border:1px solid var(--border);background:var(--panel);
}
.week-timer-left{display:flex;align-items:center;gap:8px;font-weight:600}
.week-timer-display{letter-spacing:.08em;font-variant-numeric:tabular-nums}
.week-timer-actions{display:flex;gap:8px}

/* Lista de exerc√≠cios do DIA (aluno) */
.session-ex-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:12px;padding:12px;margin-bottom:10px
}
.session-ex-header{
  display:flex;justify-content:space-between;align-items:center;gap:8px
}
.session-ex-main{display:flex;align-items:center;gap:8px}
.session-ex-meta{
  margin-top:6px;font-size:13px;color:var(--sub);
  display:flex;flex-direction:column;gap:4px
}
.session-ex-edit-row{display:flex;align-items:center;gap:6px}
.session-ex-edit-area{display:flex;align-items:center;gap:6px;margin-top:4px}
.session-ex-edit-area input{
  padding:4px 6px;border-radius:6px;border:1px solid var(--border);
  font-size:12px;width:80px;
}
.session-ex-timer{
  margin-top:8px;display:flex;align-items:center;gap:8px;
  font-size:13px
}

/* Modal base */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.35);
  display:flex;align-items:center;justify-content:center;padding:16px
}
.modal{
  width:100%;max-width:520px;background:var(--panel);
  border-radius:16px;border:1px solid var(--border);padding:20px
}

/* Pequenos toques */
hr.sep{border:0;border-top:1px dashed var(--border);margin:16px 0}
</style>
</head>
<body>
<main class="wrap">

  <!-- ============ AUTH CARD ============ -->
  <section id="auth-card" class="card">
    <div class="brand"><div class="brand-logo">üèãÔ∏è</div> MeuTreino <span class="pro">PRO</span></div>
    <h2 class="title" id="view-title">Entrar</h2>
    <p class="subtitle" id="view-sub">Gerencie seus alunos facilmente.</p>
    <div id="alert" class="alert"></div>

    <!-- Login Personal -->
    <form id="form-login" class="block">
      <div class="field">
        <label>Email</label>
        <input id="login-email" type="email" required>
      </div>
      <div class="field">
        <label>Senha</label>
        <div class="password-wrapper">
          <input id="login-pass" type="password" required>
          <button type="button" class="toggle-pass" data-target="login-pass" aria-label="Mostrar senha">
            <span class="toggle-pass-icon"></span>
          </button>
        </div>
        <small id="login-caps" class="caps-hint">Caps Lock ativado</small>
      </div>
      <button class="btn primary" type="submit">Entrar</button>
    </form>

    <!-- Signup Personal -->
    <form id="form-signup" class="block hidden">
      <div class="field"><label>Nome completo</label><input id="su-name"></div>
      <div class="field"><label>Email</label><input id="su-email" type="email"></div>
      <div class="field">
        <label>Senha (6+)</label>
        <div class="password-wrapper">
          <input id="su-pass" type="password" minlength="6">
          <button type="button" class="toggle-pass" data-target="su-pass" aria-label="Mostrar senha">
            <span class="toggle-pass-icon"></span>
          </button>
        </div>
      </div>
      <button class="btn primary" type="submit">Criar conta</button>
    </form>

    <!-- Reset Password -->
    <form id="form-reset" class="block hidden">
      <div class="field"><label>Email cadastrado</label><input id="rs-email" type="email"></div>
      <button class="btn primary" type="submit">Enviar link</button>
    </form>

    <button id="btn-google" class="btn google" style="margin-top:10px">Entrar com Google</button>

    <div class="linkbar">
      <button class="link" id="go-signup">Criar conta</button>
      <button class="link" id="go-reset">Esqueci a senha</button>
      <button class="link hidden" id="go-login">Voltar login</button>
    </div>

    <div class="linkbar">
      <button class="link" id="btn-open-student-login">Sou Aluno</button>
    </div>
  </section>

  <!-- ============ APP: LISTA DE ALUNOS ============ -->
  <section id="app" class="app hidden">
    <div class="topbar">
      <strong>Meus Alunos</strong>
      <input id="search" class="search" type="text" placeholder="Pesquisar por nome...">
      <div class="tools">
        <span class="pill" id="plan-pill">Plano: Free (5)</span>
        <span class="pill" id="user-pill">...</span>
        <button id="btn-logout" class="btn ghost" style="width:auto">Sair</button>
      </div>
    </div>

    <div id="students-list" class="grid"></div>
    <button id="btn-add" class="fab" title="Novo Aluno">+</button>
  </section>

  <!-- ============ VIEW: CICLOS ============ -->
  <section id="train-view" class="view hidden">
    <div class="view-header">
      <button id="btn-back" class="back">‚Üê Voltar</button>
      <h2 id="train-title" style="margin:0">Aluno ‚Äî Treinos</h2>
      <div class="cycle-bar">
        <button id="btn-new-cycle" class="btn ghost" style="width:auto">+ Criar Ciclo</button>
      </div>
    </div>
    <div id="cycles-empty" class="helper hidden">Nenhum ciclo encontrado. Clique em <b>+ Criar Ciclo</b> para come√ßar.</div>
    <div id="cycles-list" class="list"></div>
  </section>

  <!-- ============ VIEW: DIAS ============ -->
  <section id="days-view" class="view hidden">
    <div class="view-header">
      <button id="btn-back-cycles" class="back">‚Üê Voltar aos ciclos</button>
      <h2 id="days-title" style="margin:0">Ciclo ‚Äî Dias</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btn-regen-days" class="btn ghost" style="width:auto">Recriar 7 dias</button>
      </div>
    </div>
    <div id="days-empty" class="helper hidden">Nenhum dia encontrado. Clique em <b>Recriar 7 dias</b>.</div>
    <div id="days-grid" class="days-grid"></div>
  </section>

  <!-- ============ VIEW: EXERC√çCIOS (PERSONAL) ============ -->
  <section id="ex-view" class="view hidden">
    <div class="view-header">
      <button id="btn-back-days" class="back">‚Üê Voltar aos dias</button>
      <h2 id="ex-title" style="margin:0">Dia ‚Äî Exerc√≠cios</h2>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="btn-new-ex" class="btn ghost" style="width:auto">+ Novo Exerc√≠cio</button>
    </div>
    <div id="ex-empty" class="helper hidden">Nenhum exerc√≠cio cadastrado para este dia.</div>
    <div id="ex-list" class="list"></div>
  </section>

  <!-- ============ VIEW: SEMANA (ALUNO) ‚Äì LISTA DE DIAS ============ -->
  <section id="week-view" class="week-view hidden">
    <div class="week-header">
      <div>
        <h2 style="margin:0" id="week-student-name">Rotinas de Treino</h2>
        <div id="week-personal" class="subtitle"></div>
        <div id="week-cycle" class="subtitle"></div>
      </div>
      <button id="btn-week-back" class="back" style="border:1px solid var(--border)">‚Üê Sair</button>
    </div>

    <div id="week-days"></div>
  </section>

  <!-- ============ VIEW: TREINO DO DIA (ALUNO) ============ -->
  <section id="day-session-view" class="week-view hidden">
    <div class="week-header">
      <div>
        <h2 id="session-day-title" style="margin:0">Treino do Dia</h2>
        <div id="session-student-name" class="subtitle"></div>
        <div id="session-cycle" class="subtitle"></div>
      </div>
      <button id="btn-session-back" class="back" style="border:1px solid var(--border)">‚Üê Rotinas</button>
    </div>

    <div class="week-timer">
      <div class="week-timer-left">
        <span>‚è±</span>
        <span id="session-timer-display" class="week-timer-display">00:00</span>
      </div>
      <div class="week-timer-actions">
        <button id="btn-session-timer-toggle" class="btn-xs">Iniciar</button>
        <button id="btn-session-timer-reset" class="btn-xs">Zerar</button>
      </div>
    </div>

    <div id="session-progress" class="subtitle" style="margin-bottom:12px"></div>
    <div id="session-exercises"></div>

    <div style="margin-top:16px">
      <button id="btn-session-finish" class="btn primary" style="width:100%">Concluir treino do dia</button>
    </div>
  </section>

  <!-- ============ MODAL: ALUNO (PERSONAL) ============ -->
  <div id="modal-bg" class="modal-bg hidden">
    <div class="modal">
      <h2 id="modal-title">Novo Aluno</h2>
      <form id="form-student">
        <div class="field"><label>Nome</label><input id="st-name" required></div>
        <div class="field"><label>WhatsApp</label><input id="st-phone" inputmode="tel" placeholder="(DDD) 99999-9999"></div>
        <div class="field"><label>CPF (11 d√≠gitos ‚Äî ser√° o ID do aluno)</label><input id="st-cpf" maxlength="11" required inputmode="numeric"></div>
        <div class="field"><label>Data de Nascimento</label><input id="st-birth" type="text" placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric" required></div>
        <div class="field"><label>Objetivo</label>
          <select id="st-goal">
            <option>Hipertrofia</option><option>Emagrecimento</option><option>Resist√™ncia</option>
          </select>
        </div>
        <div class="field"><label>N√≠vel</label>
          <select id="st-level"><option>Iniciante</option><option>Intermedi√°rio</option><option>Avan√ßado</option></select>
        </div>
        <div class="field"><label>Observa√ß√µes</label><textarea id="st-notes" rows="3"></textarea></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" type="submit">Salvar</button>
          <button class="btn ghost" type="button" id="btn-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============ MODAL: CICLO ============ -->
  <div id="cycle-bg" class="modal-bg hidden">
    <div class="modal">
      <h2 id="cycle-title">Criar Ciclo</h2>
      <form id="form-cycle">
        <input type="hidden" id="cycle-id">
        <div class="field"><label>Nome do Ciclo</label><input id="cycle-name" placeholder="Ex.: Hipertrofia M√™s 1" required></div>
        <div class="field"><small class="subtitle">Per√≠odo (opcional)</small></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="field" style="flex:1;min-width:160px"><label>In√≠cio</label><input id="cycle-start" type="text" placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric"></div>
          <div class="field" style="flex:1;min-width:160px"><label>Fim</label><input id="cycle-end" type="text" placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button class="btn primary" type="submit">Salvar Ciclo</button>
          <button class="btn ghost" type="button" id="btn-cycle-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============ MODAL: EXERC√çCIO (PERSONAL) ============ -->
  <div id="ex-bg" class="modal-bg hidden">
    <div class="modal">
      <h2 id="ex-modal-title">Novo Exerc√≠cio</h2>
      <form id="form-ex">
        <input type="hidden" id="ex-id">
        <div class="field"><label>Nome</label><input id="ex-name" required placeholder="Ex.: Supino Reto"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="field" style="flex:1;min-width:110px"><label>S√©ries</label><input id="ex-sets" type="number" min="1" step="1" placeholder="4"></div>
          <div class="field" style="flex:1;min-width:110px"><label>Repeti√ß√µes</label><input id="ex-reps" type="text" placeholder="10 ou 12-10-8"></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="field" style="flex:1;min-width:110px"><label>Carga</label><input id="ex-load" type="text" placeholder="30 kg"></div>
          <div class="field" style="flex:1;min-width:110px"><label>Descanso</label><input id="ex-rest" type="text" placeholder="60 s"></div>
        </div>
        <div class="field"><label>Observa√ß√µes</label><textarea id="ex-notes" rows="3" placeholder="Ex.: manter postura; n√£o travar cotovelos"></textarea></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" type="submit">Salvar</button>
          <button class="btn ghost" type="button" id="btn-ex-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============ MODAL: LOGIN ALUNO ============ -->
  <div id="student-login-bg" class="modal-bg hidden" style="z-index:2100">
    <div class="modal" style="max-width:380px">
      <h2>Entrar como Aluno</h2>
      <p class="subtitle">Acesse seu treino com CPF (11 d√≠gitos) + Data de Nascimento.</p>
      <form id="form-student-login">
        <div class="field"><label>CPF (somente n√∫meros)</label>
          <input id="stu-cpf" maxlength="11" placeholder="Somente n√∫meros" required inputmode="numeric"></div>
        <div class="field"><label>Data de nascimento</label>
          <input id="stu-birth" type="text" placeholder="DD/MM/AAAA" maxlength="10" required inputmode="numeric"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn primary" type="submit">Entrar</button>
          <button class="btn ghost" type="button" id="btn-stu-login-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============ MODAL PREMIUM: SAIR DO TREINO (ALUNO) ============ -->
  <div id="exit-student-bg" class="modal-bg hidden" style="z-index:2200">
    <div class="modal" style="max-width:420px">
      <h2 style="margin-top:0;display:flex;align-items:center;gap:8px;font-size:18px">
        <span>üîí</span> Sair do treino?
      </h2>
      <p class="subtitle" style="margin-bottom:4px">
        Tem certeza que deseja sair da √°rea do aluno agora?
      </p>
      <p class="subtitle">
        O temporizador ser√° pausado automaticamente.
      </p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;flex-wrap:wrap">
        <button type="button" id="exit-student-cancel" class="btn ghost" style="width:auto">‚ùå Cancelar</button>
        <button type="button" id="exit-student-confirm" class="btn primary" style="width:auto">Sair</button>
      </div>
    </div>
  </div>

</main>

<!-- ===================== JS √öNICO (Firebase + App) ===================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword,
  createUserWithEmailAndPassword, sendPasswordResetEmail,
  GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import {
  getFirestore, collection, doc, addDoc, getDoc, getDocs,
  updateDoc, deleteDoc, query, where, setDoc, serverTimestamp,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

/* --------------- CONFIG DO SEU PROJETO --------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBsPf40matUV8So60OHb0h4oRwMRWaB0ho",
  authDomain: "acdm-70082.firebaseapp.com",
  projectId: "acdm-70082",
  storageBucket: "acdm-70082.firebasestorage.app",
  messagingSenderId: "236961358499",
  appId: "1:236961358499:web:40b7391c4c9b3405ff1516",
  measurementId: "G-BR85P1C0X8"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* --------------- Helpers UI --------------- */
const $  = (id)=>document.getElementById(id);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
const alertBox = $("alert");
function showAlert(msg, ok=false, ms = ok ? 1800 : 3500){
  if(!alertBox){ alert(msg); return; }
  alertBox.innerText = msg;
  alertBox.classList.remove("hidden","ok");
  if (ok) alertBox.classList.add("ok");
  alertBox.style.display = "block";
  clearTimeout(showAlert._t);
  showAlert._t = setTimeout(()=> alertBox.style.display = "none", ms);
}
function hideAlert(){ if(alertBox) alertBox.style.display = "none"; }
function show(el){ el?.classList?.remove("hidden"); }
function hide(el){ el?.classList?.add("hidden"); }

function onlyDigits(s){ return (s||"").replace(/\D/g,""); }
function isCpf11(s){ return /^\d{11}$/.test(onlyDigits(s)); }

function maskDateBR(input){
  input.addEventListener("input",(e)=>{
    let v = e.target.value.replace(/\D/g,"").slice(0,8);
    if(v.length>4) v = v.slice(0,2)+"/"+v.slice(2,4)+"/"+v.slice(4);
    else if(v.length>2) v = v.slice(0,2)+"/"+v.slice(2);
    e.target.value = v;
  });
}
function isValidDateBR(str){
  if(!/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return false;
  const [d,m,y] = str.split("/").map(Number);
  const dt = new Date(y,m-1,d);
  return dt.getFullYear()===y && dt.getMonth()+1===m && dt.getDate()===d;
}
function ymdToBr(ymd){
  if(!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return ymd;
  const [y,m,d] = ymd.split("-");
  return `${d}/${m}/${y}`;
}
["st-birth","cycle-start","cycle-end","stu-birth"].forEach(id=>{
  const el = $(id); if(el) maskDateBR(el);
});

/* --------------- Helpers treino --------------- */
function normalizeLoadInput(str){
  const t = (str||"").trim();
  if(!t) return "‚Äî";
  // se for s√≥ n√∫mero (ou n√∫mero com v√≠rgula/ponto), coloca "kg" no final
  if(/^\d+([.,]\d+)?$/.test(t) && !/[a-zA-Z]/.test(t)){
    return t.replace(",",".")+" kg";
  }
  return t;
}

/* --------- Estado Global --------- */
let isStudentMode = false;
let currentUser   = null;
let currentPlan   = { plan:"free", limit:5 };
let studentsCache = [];
let unsubStudents = null, unsubCycles = null, unsubDays = null, unsubEx = null;
let currentStudent = null, currentCycle = null, currentDay = null;
let weekStudentId = null;

/* --------- Timer GERAL do treino do dia (aluno) --------- */
let sessionTimerInterval = null;
let sessionElapsedSeconds = 0;

function formatTimer(sec){
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function updateSessionTimerUI(){
  const el = $("session-timer-display");
  if(el) el.textContent = formatTimer(sessionElapsedSeconds);
  const btn = $("btn-session-timer-toggle");
  if(btn) btn.textContent = sessionTimerInterval ? "Pausar" : "Iniciar";
}
function startSessionTimer(){
  if(sessionTimerInterval) return;
  sessionTimerInterval = setInterval(()=>{
    sessionElapsedSeconds++;
    updateSessionTimerUI();
  },1000);
  updateSessionTimerUI();
}
function pauseSessionTimer(){
  if(!sessionTimerInterval) return;
  clearInterval(sessionTimerInterval);
  sessionTimerInterval = null;
  updateSessionTimerUI();
}
function resetSessionTimer(){
  pauseSessionTimer();
  sessionElapsedSeconds = 0;
  updateSessionTimerUI();
}
$("btn-session-timer-toggle")?.addEventListener("click",()=>{
  sessionTimerInterval ? pauseSessionTimer() : startSessionTimer();
});
$("btn-session-timer-reset")?.addEventListener("click",resetSessionTimer);

/* --------- Timer INDIVIDUAL por exerc√≠cio (aluno) --------- */
let exTimers = {}; // key -> {sec, interval, running}

function stopAllExTimers(){
  Object.values(exTimers).forEach(t=>{
    if(t.interval) clearInterval(t.interval);
  });
  exTimers = {};
}

/* --------- LocalStorage progresso aluno --------- */
function progressKey(studentId){ return `meutreino_progress_${studentId}`; }
function loadProgress(studentId){
  if(!studentId) return {};
  try{
    const raw = localStorage.getItem(progressKey(studentId));
    return raw ? JSON.parse(raw) : {};
  }catch{ return {}; }
}
function saveProgress(studentId,data){
  if(!studentId) return;
  try{ localStorage.setItem(progressKey(studentId), JSON.stringify(data)); }catch{}
}

/* --------- Views --------- */
const VIEWS = ["auth-card","app","train-view","days-view","ex-view","week-view","day-session-view"];
let currentView = "auth-card";
function applySecurityView(){
  if(isStudentMode){
    hide($("btn-add")); hide($("plan-pill")); hide($("user-pill"));
    hide($("btn-new-cycle")); hide($("btn-new-ex"));
  }else{
    show($("btn-add")); show($("plan-pill")); show($("user-pill"));
    show($("btn-new-cycle")); show($("btn-new-ex"));
  }
}
function goTo(viewId){
  VIEWS.forEach(id => $(id)?.classList.add("hidden"));
  $(viewId)?.classList.remove("hidden");
  currentView = viewId;
  applySecurityView();
}

/* --------- Auth State (personal) --------- */
async function ensureUserDoc(){
  if(!auth.currentUser) return;
  const uref = doc(db,"users",auth.currentUser.uid);
  const usnap = await getDoc(uref);
  if(!usnap.exists()){
    await setDoc(uref,{
      plan:"free",limit:5,email:auth.currentUser.email||"",createdAt:serverTimestamp()
    },{merge:true});
    currentPlan={plan:"free",limit:5};
  }else currentPlan = usnap.data() || {plan:"free",limit:5};
  $("plan-pill").innerText =
    currentPlan.plan==="pro" ? "Plano: PRO (ilimitado)" :
    `Plano: Free (${currentPlan.limit||5})`;
}
onAuthStateChanged(auth, async (user)=>{
  if(user && !isStudentMode){
    currentUser = user;
    $("user-pill").innerText = user.email || "Personal";
    await ensureUserDoc();
    await startStudentsSnapshot();
    goTo("app");
  }else{
    if(!isStudentMode){
      resetRealtime(); resetContext();
      currentUser=null;
      goTo("auth-card");
    }
  }
});

/* --------- Login / Signup / Reset --------- */
$("form-login")?.addEventListener("submit",async(e)=>{
  e.preventDefault();
  try{
    await signInWithEmailAndPassword(auth,$("login-email").value.trim(),$("login-pass").value);
    hideAlert();
  }catch(err){ showAlert("Erro ao entrar: "+err.message); }
});
$("btn-google")?.addEventListener("click",async()=>{
  try{ await signInWithPopup(auth,new GoogleAuthProvider()); }
  catch(err){ showAlert("Erro: "+err.message); }
});
$("go-signup")?.addEventListener("click",()=>{
  hide($("form-login")); hide($("btn-google"));
  show($("form-signup")); show($("go-login"));
  hide($("go-signup"));
  show($("go-reset"));
  $("view-title").innerText="Criar conta";
  $("view-sub").innerText="Cadastre-se para atender seus alunos.";
  hideAlert();
});
$("go-login")?.addEventListener("click",()=>{
  show($("form-login")); show($("btn-google"));
  hide($("form-signup")); hide($("form-reset")); hide($("go-login"));
  show($("go-signup"));
  show($("go-reset"));
  $("view-title").innerText="Entrar";
  $("view-sub").innerText="Gerencie seus alunos facilmente.";
  hideAlert();
});
$("go-reset")?.addEventListener("click",()=>{
  hide($("form-login")); hide($("form-signup")); hide($("btn-google"));
  show($("form-reset")); show($("go-login"));
  hide($("go-reset"));
  hide($("go-signup"));
  $("view-title").innerText="Recuperar Senha";
  $("view-sub").innerText="Informe seu email cadastrado.";
  hideAlert();
});
$("form-signup")?.addEventListener("submit",async(e)=>{
  e.preventDefault();
  try{
    await createUserWithEmailAndPassword(auth,$("su-email").value.trim(),$("su-pass").value);
    showAlert("Conta criada com sucesso!",true);
    $("go-login").click();
  }catch(err){ showAlert(err.message); }
});
$("form-reset")?.addEventListener("submit",async(e)=>{
  e.preventDefault();
  try{
    await sendPasswordResetEmail(auth,$("rs-email").value.trim());
    showAlert("Email enviado!",true);
    $("go-login").click();
  }catch(err){ showAlert("Erro: "+err.message); }
});
$("btn-logout")?.addEventListener("click",async()=>{
  isStudentMode=false;
  await signOut(auth).catch(()=>{});
  resetRealtime(); resetContext();
  goTo("auth-card");
  showAlert("Voc√™ saiu ‚úÖ",true);
});

/* --------- Caps Lock + mostrar senha --------- */
function attachCapsLockWatcher(inputId,hintId){
  const input=$(inputId), hint=$(hintId);
  if(!input||!hint) return;
  function update(e){
    if(typeof e.getModifierState!=="function") return;
    const on=e.getModifierState("CapsLock");
    hint.style.display=on?"block":"none";
  }
  input.addEventListener("keydown",update);
  input.addEventListener("keyup",update);
  input.addEventListener("blur",()=>{hint.style.display="none";});
}
attachCapsLockWatcher("login-pass","login-caps");
$$(".toggle-pass").forEach(btn=>{
  btn.addEventListener("click",()=>{
    const targetId=btn.dataset.target;
    const input=$(targetId);
    if(!input) return;
    const isPwd=input.type==="password";
    input.type=isPwd?"text":"password";
    btn.classList.toggle("toggle-pass--on",!isPwd);
  });
});

/* --------- Lista de Alunos (personal) --------- */
async function startStudentsSnapshot(){
  if(!auth.currentUser) return;
  unsubStudents?.();
  const qOwner = query(collection(db,"students"),where("ownerId","==",auth.currentUser.uid));
  unsubStudents = onSnapshot(qOwner,(snap)=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    arr.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    studentsCache=arr;
    renderStudents();
  });
}
$("search")?.addEventListener("input",renderStudents);
function studentCardHTML(st){
  return `
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
      <strong>${st.name||"(Sem nome)"}</strong>
      <span class="badge">${st.level||"‚Äî"}</span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="badge">üéØ ${st.goal||"‚Äî"}</span>
      ${
        st.phone
          ? `<a class="btn-sm brand" style="margin-left:auto" href="https://wa.me/55${onlyDigits(st.phone)}" target="_blank" rel="noopener">WhatsApp</a>`
          : `<span class="badge" style="margin-left:auto">Sem telefone</span>`
      }
    </div>
    ${st.notes ? `<div class="badge" style="white-space:pre-wrap">üìù ${st.notes}</div>` : ""}
    <div class="actions">
      <button class="btn-sm brand" data-train>Treinos</button>
      <button class="btn-sm" data-edit>Editar</button>
      <button class="btn-sm danger" data-del>Excluir</button>
    </div>
  `;
}
function renderStudents(){
  const term = ($("search")?.value||"").toLowerCase();
  $("students-list").innerHTML="";
  studentsCache
    .filter(s => (s.name||"").toLowerCase().includes(term))
    .forEach(st=>{
      const card=document.createElement("div");
      card.className="card-student";
      card.innerHTML=studentCardHTML(st);
      card.querySelector("[data-train]").onclick = ()=>openTrainView(st);
      card.querySelector("[data-edit]").onclick  = ()=>openStudentModal(st);
      card.querySelector("[data-del]").onclick   = ()=>deleteStudent(st);
      $("students-list").appendChild(card);
    });
}
$("btn-add")?.addEventListener("click",()=>{
  if((currentPlan.plan||"free")!=="pro" && studentsCache.length>=(currentPlan.limit||5)){
    showAlert("Limite do Plano Free atingido. Atualize para PRO para cadastrar mais alunos.");
    return;
  }
  $("modal-title").innerText="Novo Aluno";
  $("form-student").reset();
  $("modal-bg").classList.remove("hidden");
});
$("btn-cancel")?.addEventListener("click",()=> $("modal-bg").classList.add("hidden"));

function openStudentModal(st){
  $("modal-title").innerText="Editar Aluno";
  $("st-name").value  = st.name  || "";
  $("st-phone").value = st.phone || "";
  $("st-cpf").value   = st.cpf   || "";
  $("st-birth").value = st.birth || "";
  $("st-goal").value  = st.goal  || "Hipertrofia";
  $("st-level").value = st.level || "Iniciante";
  $("st-notes").value = st.notes || "";
  $("modal-bg").classList.remove("hidden");
}

/* Salvar aluno (CPF campo, id auto) */
$("form-student").addEventListener("submit",async(e)=>{
  e.preventDefault();
  const cpf = onlyDigits($("st-cpf").value);
  const birthBR = ($("st-birth").value||"").trim();
  if(!($("st-name").value||"").trim()) return showAlert("Nome obrigat√≥rio!");
  if(!isCpf11(cpf)) return showAlert("CPF deve ter 11 d√≠gitos!");
  if(!isValidDateBR(birthBR)) return showAlert("Data inv√°lida! Use DD/MM/AAAA");

  const payload = {
    ownerId: auth.currentUser?.uid || null,
    name: ($("st-name").value||"").trim(),
    phone: onlyDigits($("st-phone").value),
    cpf, birth: birthBR,
    goal:$("st-goal").value,
    level:$("st-level").value,
    notes:($("st-notes").value||"").trim(),
    updatedAt:serverTimestamp(),
  };

  try{
    const q = query(
      collection(db,"students"),
      where("ownerId","==",auth.currentUser.uid),
      where("cpf","==",cpf)
    );
    const qsnap = await getDocs(q);
    if(qsnap.empty){
      await addDoc(collection(db,"students"),{...payload,createdAt:serverTimestamp()});
      showAlert("Aluno cadastrado ‚úÖ",true);
    }else{
      const docRef = qsnap.docs[0].ref;
      await updateDoc(docRef,payload);
      showAlert("Aluno atualizado ‚úÖ",true);
    }
    $("modal-bg").classList.add("hidden");
  }catch(err){ showAlert("Erro ao salvar: "+err.message); }
});
async function deleteStudent(st){
  if(!confirm(`Excluir ${st.name}?`)) return;
  try{
    await deleteDoc(doc(db,"students",st.id));
    showAlert("Aluno removido ‚úÖ",true);
  }catch(err){ showAlert("Erro ao excluir: "+err.message); }
}

/* --------- Ciclos --------- */
let cyclesCache=[];
function openTrainView(st){
  if(isStudentMode) return;
  currentStudent=st;
  $("train-title").innerText=`${st.name} ‚Äî Treinos`;
  goTo("train-view");
  startCyclesSnapshot();
}
$("btn-new-cycle")?.addEventListener("click",()=>{
  if(isStudentMode || !currentStudent) return;
  $("cycle-title").innerText="Novo Ciclo";
  $("cycle-id").value="";
  $("form-cycle").reset();
  $("cycle-bg").classList.remove("hidden");
});
$("btn-cycle-cancel")?.addEventListener("click",()=> $("cycle-bg").classList.add("hidden"));

function cycleHTML(c){
  const period = (c.start && c.end) ? `üìÖ ${c.start} ‚Äî ${c.end}` : "üìÖ Sem per√≠odo";
  return `
    <strong>${c.name||"Sem nome"}</strong>
    <small>${period}</small>
    <div class="actions" style="margin-top:8px">
      <button class="btn-sm brand" data-open>Dias</button>
      ${isStudentMode ? "" : `
      <button class="btn-sm" data-edit>Editar</button>
      <button class="btn-sm danger" data-del>Excluir</button>`}
    </div>
  `;
}
function renderCycles(list){
  const wrap=$("cycles-list"), empty=$("cycles-empty");
  if(!list.length){ show(empty); hide(wrap); return; }
  hide(empty); show(wrap); wrap.innerHTML="";
  list.forEach(c=>{
    const div=document.createElement("div");
    div.className="card-student";
    div.innerHTML=cycleHTML(c);
    div.querySelector("[data-open]").onclick = ()=>openDays(c);
    if(!isStudentMode){
      div.querySelector("[data-edit]").onclick = ()=>openCycleModal(c);
      div.querySelector("[data-del]").onclick = ()=>deleteCycle(c);
    }
    wrap.appendChild(div);
  });
}
async function startCyclesSnapshot(){
  if(!currentStudent) return;
  const ref = collection(db,"students",currentStudent.id,"cycles");
  unsubCycles?.(); unsubCycles = onSnapshot(ref,snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    arr.sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
    cyclesCache=arr; renderCycles(arr);
  });
}
function openCycleModal(c){
  $("cycle-title").innerText="Editar Ciclo";
  $("cycle-id").value   = c.id;
  $("cycle-name").value = c.name || "";
  $("cycle-start").value= c.start||"";
  $("cycle-end").value  = c.end  ||"";
  $("cycle-bg").classList.remove("hidden");
}
$("form-cycle")?.addEventListener("submit",async(e)=>{
  e.preventDefault();
  if(isStudentMode || !currentStudent) return;
  const start=$("cycle-start").value.trim();
  const end  =$("cycle-end").value.trim();
  if(start && !isValidDateBR(start)) return showAlert("Data de in√≠cio inv√°lida (DD/MM/AAAA)");
  if(end   && !isValidDateBR(end))   return showAlert("Data de fim inv√°lida (DD/MM/AAAA)");

  const payload={
    name:$("cycle-name").value.trim(),
    start:start||null,
    end:end||null,
    updatedAt:serverTimestamp()
  };
  if(!payload.name) return showAlert("Nome obrigat√≥rio!");
  const sid=currentStudent.id;
  const id=$("cycle-id").value;
  const cref=id?doc(db,"students",sid,"cycles",id):doc(db,"students",sid,"cycles",crypto.randomUUID());
  try{
    if(!id) payload.createdAt=serverTimestamp();
    await setDoc(cref,payload,{merge:true});
    $("cycle-bg").classList.add("hidden");
  }catch(err){ showAlert("Erro ao salvar ciclo: "+err.message); }
});
async function deleteCycle(c){
  if(!confirm(`Excluir ciclo "${c.name}"?`)) return;
  try{
    await deleteDoc(doc(db,"students",currentStudent.id,"cycles",c.id));
    showAlert("Ciclo removido ‚úÖ",true);
  }catch(err){ showAlert("Erro: "+err.message); }
}

/* --------- Dias --------- */
function openDays(cycle){
  currentCycle=cycle;
  $("days-title").innerText=`${cycle.name}`;
  goTo("days-view");
  startDaysSnapshot();
}
function startDaysSnapshot(){
  if(!currentStudent || !currentCycle) return;
  const ref = collection(db,"students",currentStudent.id,"cycles",currentCycle.id,"days");
  unsubDays?.(); unsubDays = onSnapshot(ref,snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    arr.sort((a,b)=>(a.order||0)-(b.order||0));
    renderDays(arr);
  });
}
function dayHTML(d){
  return `
    <div class="day-top"><span>${d.name}</span><span>${d.exercisesCount||0} ex.</span></div>
    <div class="day-actions"><button class="btn-sm brand" data-open>Ver exerc√≠cios</button></div>
  `;
}
function renderDays(list){
  const wrap=$("days-grid"), empty=$("days-empty");
  if(!list.length){ show(empty); hide(wrap); return; }
  hide(empty); show(wrap); wrap.innerHTML="";
  list.forEach(day=>{
    const el=document.createElement("div");
    el.className="day-card";
    el.innerHTML=dayHTML(day);
    el.querySelector("[data-open]").onclick = ()=>openExercises(day);
    wrap.appendChild(el);
  });
}
$("btn-regen-days")?.addEventListener("click",ensure7Days);
async function ensure7Days(){
  if(!currentCycle) return;
  const DAYS=[
    {id:"seg",name:"SEGUNDA",order:1},
    {id:"ter",name:"TER√áA",order:2},
    {id:"qua",name:"QUARTA",order:3},
    {id:"qui",name:"QUINTA",order:4},
    {id:"sex",name:"SEXTA",order:5},
    {id:"sab",name:"S√ÅBADO",order:6},
    {id:"dom",name:"DOMINGO",order:7},
  ];
  const ref = collection(db,"students",currentStudent.id,"cycles",currentCycle.id,"days");
  const existing = await getDocs(ref);
  const ids={}; existing.forEach(d=>ids[d.id]=true);
  for(const d of DAYS){
    if(!ids[d.id]){
      await setDoc(doc(ref,d.id),{
        name:d.name,order:d.order,exercisesCount:0,
        createdAt:serverTimestamp(),updatedAt:serverTimestamp()
      });
    }
  }
  showAlert("Dias recriados ‚úÖ",true);
}

/* --------- Exerc√≠cios (personal) --------- */
function openExercises(day){
  currentDay=day;
  $("ex-title").innerText=`${currentCycle.name} ‚Äî ${day.name}`;
  goTo("ex-view");
  subscribeExercises();
}
function subscribeExercises(){
  if(!currentStudent || !currentCycle || !currentDay) return;
  const ref = collection(
    db,"students",currentStudent.id,
    "cycles",currentCycle.id,"days",currentDay.id,"exercises"
  );
  unsubEx?.(); unsubEx = onSnapshot(ref,snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    arr.sort((a,b)=>(a.order||0)-(b.order||0));
    renderExercises(arr);
    updateDoc(doc(db,"students",currentStudent.id,"cycles",currentCycle.id,"days",currentDay.id),{
      exercisesCount:arr.length,updatedAt:serverTimestamp()
    }).catch(()=>{});
  });
}
$("btn-new-ex")?.addEventListener("click",()=>{
  if(isStudentMode) return showAlert("Aluno n√£o pode editar!");
  $("ex-id").value="";
  $("ex-modal-title").innerText="Novo Exerc√≠cio";
  $("form-ex").reset();
  $("ex-bg").classList.remove("hidden");
});
$("btn-ex-cancel")?.addEventListener("click",()=> $("ex-bg").classList.add("hidden"));

function toTitleCase(str){
  return str
    .toLowerCase()
    .split(" ")
    .filter(Boolean)
    .map(w=>w.charAt(0).toUpperCase()+w.slice(1))
    .join(" ");
}
$("form-ex")?.addEventListener("submit",async(e)=>{
  e.preventDefault();
  if(isStudentMode) return;
  const id = $("ex-id").value;
  const rawName = $("ex-name").value.trim();
  if(!rawName) return showAlert("Informe o nome do exerc√≠cio.");
  const data = {
    name: toTitleCase(rawName),
    sets: $("ex-sets").value.trim(),
    reps: $("ex-reps").value.trim(),
    load: $("ex-load").value.trim(),
    rest: $("ex-rest").value.trim(),
    notes: $("ex-notes").value.trim(),
    updatedAt: serverTimestamp()
  };
  const ref = collection(
    db,"students",currentStudent.id,
    "cycles",currentCycle.id,"days",currentDay.id,"exercises"
  );
  try{
    if(id){
      await updateDoc(doc(ref,id),data);
      showAlert("Exerc√≠cio atualizado ‚úÖ",true);
    }else{
      const snap=await getDocs(ref);
      const order=snap.size+1;
      await addDoc(ref,{...data,order,createdAt:serverTimestamp()});
      showAlert("Exerc√≠cio adicionado ‚úÖ",true);
    }
    $("ex-bg").classList.add("hidden");
  }catch(err){ showAlert("Erro: "+err.message); }
});
function exHTML(e){
  return `
    <div class="ex-card">
      <div class="ex-top">
        <div class="ex-name">${e.name}</div>
        ${
          !isStudentMode ? `
          <div class="ex-actions">
            <button class="btn-xs" data-edit>‚úèÔ∏è</button>
            <button class="btn-xs danger" data-del>üóë</button>
          </div>` : ""
        }
      </div>
      <div class="ex-line">
        <span class="ex-chip"><b>${e.sets||"‚Äî"}</b> s√©ries</span>
        <span class="ex-chip">${e.reps||"‚Äî"} reps</span>
        <span class="ex-chip">Carga: ${e.load||"‚Äî"}</span>
        <span class="ex-chip">Descanso: ${e.rest||"‚Äî"}</span>
      </div>
      ${e.notes ? `<div class="ex-line" style="color:var(--sub)">Obs: ${e.notes}</div>` : ""}
    </div>
  `;
}
function renderExercises(list){
  const wrap=$("ex-list");
  wrap.innerHTML="";
  if(!list.length){ show($("ex-empty")); return; }
  hide($("ex-empty"));
  list.forEach(e=>{
    const card=document.createElement("div");
    card.innerHTML=exHTML(e);
    if(!isStudentMode){
      card.querySelector("[data-edit]").onclick = ()=>{
        $("ex-id").value=e.id;
        $("ex-modal-title").innerText="Editar Exerc√≠cio";
        $("ex-name").value=e.name||"";
        $("ex-sets").value=e.sets||"";
        $("ex-reps").value=e.reps||"";
        $("ex-load").value=e.load||"";
        $("ex-rest").value=e.rest||"";
        $("ex-notes").value=e.notes||"";
        $("ex-bg").classList.remove("hidden");
      };
      card.querySelector("[data-del]").onclick = async()=>{
        if(confirm("Excluir exerc√≠cio?")){
          await deleteDoc(doc(
            db,"students",currentStudent.id,
            "cycles",currentCycle.id,"days",currentDay.id,"exercises",e.id
          ));
        }
      };
    }
    wrap.appendChild(card);
  });
}

/* --------- Semana do aluno (lista de dias) --------- */
const DAY_ORDER = ["seg","ter","qua","qui","sex","sab","dom"];
const DAY_LABEL = {
  seg:"Segunda",ter:"Ter√ßa",qua:"Quarta",
  qui:"Quinta",sex:"Sexta",sab:"S√°bado",dom:"Domingo"
};
function todayId(){ return ["dom","seg","ter","qua","qui","sex","sab"][new Date().getDay()]; }
function formatDate(d){
  if(!d) return "";
  const t = typeof d==="string" ? d : d.toDate?.() || null;
  if(!t) return "";
  return /^\d{4}-\d{2}-\d{2}$/.test(t) ? ymdToBr(t) : t;
}
async function pickActiveCycle(studentId){
  const ref=collection(db,"students",studentId,"cycles");
  const snap=await getDocs(ref);
  if(snap.empty) return null;
  const cycles=[];
  snap.forEach(d=>{
    const c={id:d.id,...d.data()};
    c._created=c.createdAt?.seconds||0;
    cycles.push(c);
  });
  cycles.sort((a,b)=>b._created-a._created);
  return cycles[0];
}
async function fetchWeek(studentId,cycleId){
  const daysRef=collection(db,"students",studentId,"cycles",cycleId,"days");
  const dSnap=await getDocs(daysRef);
  const map={};
  dSnap.forEach(d=>{ map[d.id]={id:d.id,...d.data(),exercises:[]}; });
  for(const id of DAY_ORDER){
    if(!map[id]) map[id]={id,name:DAY_LABEL[id],order:DAY_ORDER.indexOf(id)+1,exercises:[]};
    const exRef=collection(db,"students",studentId,"cycles",cycleId,"days",id,"exercises");
    const exSnap=await getDocs(exRef);
    const list=[]; exSnap.forEach(e=>list.push({id:e.id,...e.data()}));
    list.sort((a,b)=>(a.order||0)-(b.order||0));
    map[id].exercises=list;
  }
  return map;
}

let weekData = null;
let currentSessionDayId = null;

function renderWeek(map){
  weekData = map;
  const wrap=$("week-days");
  wrap.innerHTML="";
  const today=todayId();
  const progress=loadProgress(weekStudentId);

  DAY_ORDER.forEach(id=>{
    const d = map[id];
    const exList = d.exercises||[];
    const total = exList.length;
    let doneCount = 0;
    exList.forEach(e=>{
      const key=`${id}_${e.id}`;
      if(progress[key]?.done) doneCount++;
    });
    const status =
      total===0 ? "Nenhum exerc√≠cio cadastrado" :
      doneCount===0 ? "Voc√™ ainda n√£o realizou esse treino" :
      doneCount===total ? "Treino conclu√≠do pelo menos uma vez" :
      `Voc√™ concluiu ${doneCount} de ${total} exerc√≠cios`;

    const box=document.createElement("div");
    box.className="week-day-card";
    box.innerHTML=`
      <div class="week-day-title">${DAY_LABEL[id]}${id===today?" (HOJE)":""}</div>
      <div class="week-day-sub">${total} exerc√≠cio(s)</div>
      <div class="week-day-sub">${status}</div>
      <button class="btn primary day-open" data-day-id="${id}" style="margin-top:10px;width:100%">Ver treino</button>
    `;
    box.querySelector(".day-open").addEventListener("click",()=>openDaySession(id));
    wrap.appendChild(box);
  });
}

/* --------- Tela de TREINO DO DIA (aluno) --------- */
function updateSessionProgress(day){
  const exList = day.exercises||[];
  const total = exList.length;
  const progress = loadProgress(weekStudentId);
  let doneCount = 0;
  exList.forEach(e=>{
    const key=`${currentSessionDayId}_${e.id}`;
    if(progress[key]?.done) doneCount++;
  });
  $("session-progress").textContent =
    total ? `Progresso: ${doneCount}/${total} exerc√≠cios conclu√≠dos` :
            "Nenhum exerc√≠cio cadastrado para este dia.";
}

function renderDaySessionExercises(day){
  const wrap = $("session-exercises");
  wrap.innerHTML="";
  const progress = loadProgress(weekStudentId);

  (day.exercises||[]).forEach(e=>{
    const key=`${currentSessionDayId}_${e.id}`;
    const state = progress[key] || {};
    const done = !!state.done;
    const cargaBase = state.load || e.load || "‚Äî";

    const timerKey = `${weekStudentId}_${key}`;
    if(!exTimers[timerKey]) exTimers[timerKey] = {sec:0,interval:null,running:false};

    const card=document.createElement("div");
    card.className="session-ex-card";
    card.dataset.exId=e.id;
    card.dataset.dayId=currentSessionDayId;
    card.dataset.timerKey=timerKey;

    card.innerHTML=`
      <div class="session-ex-header">
        <label class="session-ex-main">
          <input type="checkbox" class="session-ex-done" ${done?"checked":""}>
          <span><b>${e.name||"(Sem nome)"}</b></span>
        </label>
      </div>
      <div class="session-ex-meta">
        <span>S√©ries: ${e.sets||"‚Äî"} ‚Ä¢ Reps: ${e.reps||"‚Äî"} ‚Ä¢ Carga: <span class="session-ex-load">${cargaBase}</span> ‚Ä¢ Descanso: ${e.rest||"‚Äî"}</span>
        <div class="session-ex-edit-row">
          <button type="button" class="btn-xs session-ex-edit-link">Editar carga</button>
        </div>
        <div class="session-ex-edit-area hidden">
          <input type="text" class="session-ex-load-input" value="${cargaBase==="‚Äî"?"":cargaBase}">
          <button type="button" class="btn-xs session-ex-save">Salvar</button>
          <button type="button" class="btn-xs session-ex-cancel">Cancelar</button>
        </div>
      </div>
      <div class="session-ex-timer">
        <span class="session-ex-timer-display">00:00</span>
        <button type="button" class="btn-xs session-ex-timer-toggle">Iniciar</button>
        <button type="button" class="btn-xs session-ex-timer-reset">Zerar</button>
      </div>
    `;

    // checkbox feito
    card.querySelector(".session-ex-done").addEventListener("change",(ev)=>{
      const p=loadProgress(weekStudentId);
      p[key]=p[key]||{};
      p[key].done=ev.target.checked;
      saveProgress(weekStudentId,p);
      updateSessionProgress(day);
    });

    // abrir editor de carga
    const row   = card.querySelector(".session-ex-edit-row");
    const area  = card.querySelector(".session-ex-edit-area");
    const input = card.querySelector(".session-ex-load-input");
    const spanLoad = card.querySelector(".session-ex-load");

    card.querySelector(".session-ex-edit-link").addEventListener("click",()=>{
      row.style.display="none";
      area.classList.remove("hidden");
      input.focus(); input.select();
    });
    card.querySelector(".session-ex-cancel").addEventListener("click",()=>{
      area.classList.add("hidden");
      row.style.display="flex";
    });
    card.querySelector(".session-ex-save").addEventListener("click",()=>{
      const novoNorm = normalizeLoadInput(input.value);
      spanLoad.textContent = novoNorm;
      const p=loadProgress(weekStudentId);
      p[key]=p[key]||{};
      p[key].load = novoNorm;
      saveProgress(weekStudentId,p);
      area.classList.add("hidden");
      row.style.display="flex";
    });

    // timer individual
    const dispTimer = card.querySelector(".session-ex-timer-display");
    const btnToggle = card.querySelector(".session-ex-timer-toggle");
    const btnReset  = card.querySelector(".session-ex-timer-reset");

    function updateExTimerUI(){
      const t = exTimers[timerKey];
      dispTimer.textContent = formatTimer(t.sec||0);
      btnToggle.textContent = t.running ? "Pausar" : "Iniciar";
    }
    updateExTimerUI();

    btnToggle.addEventListener("click",()=>{
      const t = exTimers[timerKey];
      if(t.running){
        t.running=false;
        if(t.interval) clearInterval(t.interval);
        t.interval=null;
      }else{
        t.running=true;
        t.interval=setInterval(()=>{
          t.sec++;
          updateExTimerUI();
        },1000);
      }
      updateExTimerUI();
    });

    btnReset.addEventListener("click",()=>{
      const t = exTimers[timerKey];
      if(t.interval) clearInterval(t.interval);
      t.interval=null;
      t.running=false;
      t.sec=0;
      updateExTimerUI();
    });

    wrap.appendChild(card);
  });

  updateSessionProgress(day);
}

function openDaySession(dayId){
  currentSessionDayId = dayId;
  const day = weekData?.[dayId];
  if(!day) return;
  stopAllExTimers();
  resetSessionTimer();

  $("session-day-title").innerText = `Treino de ${DAY_LABEL[dayId]}`;
  $("session-student-name").innerText = $("week-student-name").textContent || "";
  $("session-cycle").innerText = $("week-cycle").textContent || "";

  renderDaySessionExercises(day);
  goTo("day-session-view");
}

/* --------- Login + abertura da semana --------- */
async function openWeekView(studentDoc){
  try{
    isStudentMode=true;
    currentStudent=studentDoc;
    weekStudentId=studentDoc.id;
    resetSessionTimer();
    stopAllExTimers();

    const cycle=await pickActiveCycle(studentDoc.id);
    $("week-student-name").innerText=studentDoc.name || "Seu Treino";
    $("session-student-name").innerText=studentDoc.name || "Seu Treino";
    $("week-personal").innerText="";
    $("week-cycle").innerText =
      cycle ? (cycle.name||"Ciclo") + (cycle.start&&cycle.end ? ` (${formatDate(cycle.start)} ‚Äî ${formatDate(cycle.end)})` : "")
            : "Sem ciclo ativo";
    $("session-cycle").innerText = $("week-cycle").textContent;

    if(!cycle){
      goTo("week-view");
      $("week-days").innerHTML=
        `<div class="week-day-card">
           <div class="week-day-title">Sem ciclo</div>
           <div class="week-day-sub">0 exerc√≠cio(s)</div>
           <div class="week-day-sub">Pe√ßa ao seu personal para cadastrar um ciclo.</div>
         </div>`;
      return;
    }
    const week=await fetchWeek(studentDoc.id,cycle.id);
    goTo("week-view");
    renderWeek(week);
    showAlert("Bons treinos! üí™",true);
  }catch(err){
    console.error(err);
    showAlert("Erro ao carregar a semana: "+err.message);
  }
}

/* --------- Login aluno --------- */
$("btn-open-student-login")?.addEventListener("click",()=>{
  $("stu-cpf").value="";
  $("stu-birth").value="";
  $("student-login-bg").classList.remove("hidden");
});
$("btn-stu-login-cancel")?.addEventListener("click",()=> $("student-login-bg").classList.add("hidden"));

$("form-student-login")?.addEventListener("submit",async(e)=>{
  e.preventDefault();
  let cpf=onlyDigits($("stu-cpf").value);
  let birthBR=($("stu-birth").value||"").trim();
  if(cpf.length!==11) return showAlert("CPF deve ter 11 n√∫meros!");
  if(!isValidDateBR(birthBR)) return showAlert("Data inv√°lida! Use DD/MM/AAAA");

  try{
    await signInAnonymously(auth).catch(()=>{});
    const q=query(collection(db,"students"),where("cpf","==",cpf));
    const qs=await getDocs(q);
    if(qs.empty) return showAlert("Aluno n√£o encontrado. Fale com seu personal!");

    let found=null;
    qs.forEach(d=>{
      const data=d.data();
      const savedBirth=/^\d{4}-\d{2}-\d{2}$/.test(data.birth)?ymdToBr(data.birth):(data.birth||"");
      if(savedBirth===birthBR) found={id:d.id,...data};
    });
    if(!found) return showAlert("Dados n√£o conferem. Fale com seu personal.");

    $("student-login-bg").classList.add("hidden");
    await openWeekView(found);
  }catch(err){ showAlert("Erro: "+err.message); }
});

/* --------- Navega√ß√£o / reset --------- */
function resetRealtime(){
  unsubStudents?.(); unsubStudents=null;
  unsubCycles?.();   unsubCycles=null;
  unsubDays?.();     unsubDays=null;
  unsubEx?.();       unsubEx=null;
}
function resetContext(){ currentStudent=null; currentCycle=null; currentDay=null; weekStudentId=null; }

/* MODAL PREMIUM: SAIR DO TREINO (ALUNO) */
const exitStudentBg = $("exit-student-bg");
const exitCancelBtn = $("exit-student-cancel");
const exitConfirmBtn = $("exit-student-confirm");

function openExitStudentModal(){
  if(!exitStudentBg) return;
  exitStudentBg.classList.remove("hidden");
}
exitCancelBtn?.addEventListener("click",()=>{
  exitStudentBg?.classList.add("hidden");
});
exitConfirmBtn?.addEventListener("click",()=>{
  exitStudentBg?.classList.add("hidden");
  pauseSessionTimer();
  stopAllExTimers();
  isStudentMode=false;
  resetRealtime();
  resetContext();
  goTo("auth-card");
  showAlert("Voc√™ saiu da √°rea do aluno ‚úÖ",true);
});

function navBack(){
  if(isStudentMode){
    if(currentView==="day-session-view"){ // volta para lista de dias, sem sair do aluno
      stopAllExTimers();
      pauseSessionTimer();
      goTo("week-view");
      return;
    }
    if(currentView==="ex-view"){ goTo("days-view"); return; }
    if(currentView==="days-view" || currentView==="train-view"){ goTo("week-view"); return; }
    if(currentView==="week-view"){
      openExitStudentModal();
      return;
    }
    goTo("week-view");
  }else{
    if(currentView==="ex-view"){ goTo("days-view"); return; }
    if(currentView==="days-view"){ goTo("train-view"); return; }
    if(currentView==="train-view"){ goTo("app"); return; }
    goTo("app");
  }
}
$("btn-back")?.addEventListener("click",navBack);
$("btn-back-cycles")?.addEventListener("click",navBack);
$("btn-back-days")?.addEventListener("click",navBack);
$("btn-week-back")?.addEventListener("click",()=>{
  if(!isStudentMode){ goTo("app"); return; }
  openExitStudentModal();
});
$("btn-session-back")?.addEventListener("click",()=>{
  stopAllExTimers();
  pauseSessionTimer();
  goTo("week-view");
});
$("btn-session-finish")?.addEventListener("click",()=>{
  stopAllExTimers();
  resetSessionTimer();
  showAlert("Treino do dia conclu√≠do! ‚úÖ",true);
  goTo("week-view");
});

/* --------- UX extra --------- */
$("login-email")?.setAttribute("placeholder","email@exemplo.com");
$("login-pass")?.setAttribute("placeholder","‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢");
$("su-pass")?.setAttribute("placeholder","m√≠nimo 6 d√≠gitos");

/* Enter -> pr√≥ximo campo */
$$("input").forEach(inp=>{
  inp.addEventListener("keypress",(ev)=>{
    if(ev.key==="Enter"){
      const form=inp.closest("form");
      if(form){
        ev.preventDefault();
        const focusable=[...form.querySelectorAll("input,button")];
        const idx=focusable.indexOf(inp);
        if(idx>=0 && idx<focusable.length-1) focusable[idx+1].focus();
      }
    }
  });
});
</script>
</body>
</html>
