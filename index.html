<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MeuTreino PRO</title>

<!-- Fonte -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#fafafa; --panel:#fff; --border:#e6e6e6; --text:#111; --sub:#555; --muted:#f3f3f3;
  --brand:#009c3b; --brand-dark:#026a29; --danger:#e54848; --ok:#18a34a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text)}
.hidden{display:none!important}

/* ------------ Layouts ------------- */
.wrap{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:16px}
.card{
  width:100%;max-width:420px;background:var(--panel);border-radius:16px;border:1px solid var(--border);padding:26px
}
.brand{display:flex;align-items:center;gap:12px;font-size:20px;font-weight:700}
.brand-logo{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--brand);color:#fff;border-radius:8px;font-size:22px}
.pro{color:var(--brand-dark);font-weight:800}
.title{font-size:20px;margin:12px 0 6px}
.subtitle{font-size:14px;color:var(--sub);margin-bottom:14px}

/* ------------ Form ------------- */
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:14px}
input,select,textarea{padding:12px;border-radius:10px;font-size:15px;border:1px solid var(--border);background:var(--muted)}
textarea{resize:vertical}
.btn{width:100%;padding:12px;border:none;border-radius:10px;font-weight:600;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.google{background:#fff;border:1px solid #ccc;color:#333}
.btn.ghost{background:var(--panel);border:1px solid var(--border);color:var(--text)}
.linkbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;margin-top:10px}
.link{border:none;background:none;color:var(--brand-dark);font-size:14px;cursor:pointer}

/* Alert */
.alert{display:none;padding:10px;font-size:14px;margin-bottom:12px;border-radius:8px;background:#ffd8d8;color:#8a0000;white-space:pre-line}
.alert.ok{background:#daf5d8;color:#084d19}

/* ------------ App ------------- */
.app,.view,.week-view{width:100%;max-width:1100px;margin:auto;padding:20px}
.topbar{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;margin-bottom:18px}
.tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{padding:6px 12px;background:var(--muted);border-radius:12px;border:1px solid var(--border);font-size:14px}
.search{max-width:320px}
.grid{display:grid;gap:16px}
@media(min-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}

.card-student{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
.badge{background:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--sub)}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn-sm{padding:8px 10px;border-radius:8px;font-size:13px;cursor:pointer;border:1px solid var(--border);background:var(--muted)}
.btn-sm.brand{background:var(--brand);color:#fff;border:none}
.btn-sm.danger{background:var(--danger);color:#fff;border:none}
.btn-xs{padding:6px 8px;border-radius:8px;font-size:12px;border:1px solid var(--border);background:var(--muted);cursor:pointer}

/* Espa√ßo extra no bot√£o WhatsApp */
.actions .btn-sm.brand[href^="https://wa.me"]{margin-left:auto}
.actions .btn-sm.brand + .btn-sm{margin-left:8px}

/* FAB */
.fab{position:fixed;right:22px;bottom:22px;width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--brand);color:#fff;border:none;font-size:26px;box-shadow:0 10px 20px rgba(0,0,0,.15);cursor:pointer}

/* Views */
.view-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.back{padding:8px 12px;border-radius:8px;background:var(--panel);border:1px solid var(--border);cursor:pointer}
.helper{padding:14px;background:#fff7d1;border:1px dashed #e3c54b;border-radius:12px;color:#5c4a00}

/* Days / Exercises */
.days-grid{display:grid;gap:12px}
@media(min-width:700px){.days-grid{grid-template-columns:repeat(2,1fr)}}
.day-card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
.day-top{display:flex;justify-content:space-between;align-items:center;font-weight:700;margin-bottom:8px}
.day-actions{display:flex;gap:8px}

.list{display:flex;flex-direction:column;gap:12px}
.ex-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
.ex-top{display:flex;justify-content:space-between;gap:10px}
.ex-name{font-weight:700}
.ex-line{display:flex;flex-wrap:wrap;gap:8px}
.ex-chip{background:var(--muted);border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}

/* Week */
.week-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.day-box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;cursor:pointer}
.ex-list{margin-top:10px;padding-left:10px;font-size:14px}
.ex-list div{margin-bottom:6px}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px}
.modal{width:100%;max-width:520px;background:var(--panel);border-radius:16px;border:1px solid var(--border);padding:20px}

/* Pequenos toques */
hr.sep{border:0;border-top:1px dashed var(--border);margin:16px 0}
</style>
</head>
<body>
<main class="wrap">

  <!-- ============ AUTH CARD ============ -->
  <section id="auth-card" class="card">
    <div class="brand"><div class="brand-logo">üèãÔ∏è</div> MeuTreino <span class="pro">PRO</span></div>
    <h2 class="title" id="view-title">Entrar</h2>
    <p class="subtitle" id="view-sub">Gerencie seus alunos facilmente.</p>
    <div id="alert" class="alert"></div>

    <!-- Login Personal -->
    <form id="form-login" class="block">
      <div class="field"><label>Email</label><input id="login-email" type="email" required></div>
      <div class="field"><label>Senha</label><input id="login-pass" type="password" required></div>
      <button class="btn primary" type="submit">Entrar</button>
    </form>

    <!-- Signup Personal -->
    <form id="form-signup" class="block hidden">
      <div class="field"><label>Nome completo</label><input id="su-name"></div>
      <div class="field"><label>Email</label><input id="su-email" type="email"></div>
      <div class="field"><label>Senha (6+)</label><input id="su-pass" type="password" minlength="6"></div>
      <button class="btn primary" type="submit">Criar conta</button>
    </form>

    <!-- Reset Password -->
    <form id="form-reset" class="block hidden">
      <div class="field"><label>Email cadastrado</label><input id="rs-email" type="email"></div>
      <button class="btn primary" type="submit">Enviar link</button>
    </form>

    <button id="btn-google" class="btn google" style="margin-top:10px">Entrar com Google</button>

    <div class="linkbar">
      <button class="link" id="go-signup">Criar conta</button>
      <button class="link" id="go-reset">Esqueci a senha</button>
      <button class="link hidden" id="go-login">Voltar login</button>
    </div>

    <div class="linkbar">
      <button class="link" id="btn-open-student-login">Sou Aluno</button>
    </div>
  </section>

  <!-- ============ APP: LISTA DE ALUNOS ============ -->
  <section id="app" class="app hidden">
    <div class="topbar">
      <strong>Meus Alunos</strong>
      <input id="search" class="search" type="text" placeholder="Pesquisar por nome...">
      <div class="tools">
        <span class="pill" id="plan-pill">Plano: Free (5)</span>
        <span class="pill" id="user-pill">...</span>
        <button id="btn-logout" class="btn ghost" style="width:auto">Sair</button>
      </div>
    </div>

    <div id="students-list" class="grid"></div>
    <button id="btn-add" class="fab" title="Novo Aluno">+</button>
  </section>

  <!-- ============ VIEW: CICLOS ============ -->
  <section id="train-view" class="view hidden">
    <div class="view-header">
      <button id="btn-back" class="back">‚Üê Voltar</button>
      <h2 id="train-title" style="margin:0">Aluno ‚Äî Treinos</h2>
      <div class="cycle-bar">
        <button id="btn-new-cycle" class="btn ghost" style="width:auto">+ Criar Ciclo</button>
      </div>
    </div>
    <div id="cycles-empty" class="helper hidden">Nenhum ciclo encontrado. Clique em <b>+ Criar Ciclo</b> para come√ßar.</div>
    <div id="cycles-list" class="list"></div>
  </section>

  <!-- ============ VIEW: DIAS ============ -->
  <section id="days-view" class="view hidden">
    <div class="view-header">
      <button id="btn-back-cycles" class="back">‚Üê Voltar aos ciclos</button>
      <h2 id="days-title" style="margin:0">Ciclo ‚Äî Dias</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btn-regen-days" class="btn ghost" style="width:auto">Recriar 7 dias</button>
      </div>
    </div>
    <div id="days-empty" class="helper hidden">Nenhum dia encontrado. Clique em <b>Recriar 7 dias</b>.</div>
    <div id="days-grid" class="days-grid"></div>
  </section>

  <!-- ============ VIEW: EXERC√çCIOS ============ -->
  <section id="ex-view" class="view hidden">
    <div class="view-header">
      <button id="btn-back-days" class="back">‚Üê Voltar aos dias</button>
      <h2 id="ex-title" style="margin:0">Dia ‚Äî Exerc√≠cios</h2>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="btn-new-ex" class="btn ghost" style="width:auto">+ Novo Exerc√≠cio</button>
    </div>
    <div id="ex-empty" class="helper hidden">Nenhum exerc√≠cio cadastrado para este dia.</div>
    <div id="ex-list" class="list"></div>
  </section>

  <!-- ============ VIEW: SEMANA (ALUNO) ============ -->
  <section id="week-view" class="week-view hidden">
    <div class="week-header">
      <div>
        <h2 style="margin:0" id="week-student-name">Treino da Semana</h2>
        <div id="week-personal" class="subtitle"></div>
        <div id="week-cycle" class="subtitle"></div>
      </div>
      <button id="btn-week-back" class="back" style="border:1px solid var(--border)">‚Üê Sair</button>
    </div>
    <div id="week-days"></div>
  </section>

  <!-- ============ MODAL: ALUNO ============ -->
  <div id="modal-bg" class="modal-bg hidden">
    <div class="modal">
      <h2 id="modal-title">Novo Aluno</h2>
      <form id="form-student">
        <div class="field"><label>Nome</label><input id="st-name" required></div>
        <div class="field"><label>WhatsApp</label><input id="st-phone" inputmode="tel" placeholder="(DDD) 99999-9999"></div>
        <div class="field"><label>CPF (11 d√≠gitos ‚Äî ser√° o ID do aluno)</label><input id="st-cpf" maxlength="11" required inputmode="numeric"></div>
        <div class="field"><label>Data de Nascimento</label><input id="st-birth" type="date" required></div>
        <div class="field"><label>Objetivo</label>
          <select id="st-goal">
            <option>Hipertrofia</option><option>Emagrecimento</option><option>Resist√™ncia</option>
          </select>
        </div>
        <div class="field"><label>N√≠vel</label>
          <select id="st-level"><option>Iniciante</option><option>Intermedi√°rio</option><option>Avan√ßado</option></select>
        </div>
        <div class="field"><label>Observa√ß√µes</label><textarea id="st-notes" rows="3"></textarea></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" type="submit">Salvar</button>
          <button class="btn ghost" type="button" id="btn-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============ MODAL: CICLO ============ -->
  <div id="cycle-bg" class="modal-bg hidden">
    <div class="modal">
      <h2 id="cycle-title">Criar Ciclo</h2>
      <form id="form-cycle">
        <input type="hidden" id="cycle-id">
        <div class="field"><label>Nome do Ciclo</label><input id="cycle-name" placeholder="Ex.: Hipertrofia M√™s 1" required></div>
        <div class="field"><small class="subtitle">Per√≠odo (opcional)</small></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="field" style="flex:1;min-width:160px"><label>In√≠cio</label><input id="cycle-start" type="date"></div>
          <div class="field" style="flex:1;min-width:160px"><label>Fim</label><input id="cycle-end" type="date"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button class="btn primary" type="submit">Salvar Ciclo</button>
          <button class="btn ghost" type="button" id="btn-cycle-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============ MODAL: EXERC√çCIO ============ -->
  <div id="ex-bg" class="modal-bg hidden">
    <div class="modal">
      <h2 id="ex-modal-title">Novo Exerc√≠cio</h2>
      <form id="form-ex">
        <input type="hidden" id="ex-id">
        <div class="field"><label>Nome</label><input id="ex-name" required placeholder="Ex.: Supino Reto"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="field" style="flex:1;min-width:110px"><label>S√©ries</label><input id="ex-sets" type="number" min="1" step="1" placeholder="4"></div>
          <div class="field" style="flex:1;min-width:110px"><label>Repeti√ß√µes</label><input id="ex-reps" type="text" placeholder="10 ou 12-10-8"></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="field" style="flex:1;min-width:110px"><label>Carga</label><input id="ex-load" type="text" placeholder="30 kg"></div>
          <div class="field" style="flex:1;min-width:110px"><label>Descanso</label><input id="ex-rest" type="text" placeholder="60 s"></div>
        </div>
        <div class="field"><label>Observa√ß√µes</label><textarea id="ex-notes" rows="3" placeholder="Ex.: manter postura; n√£o travar cotovelos"></textarea></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" type="submit">Salvar</button>
          <button class="btn ghost" type="button" id="btn-ex-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============ MODAL: LOGIN ALUNO ============ -->
  <div id="student-login-bg" class="modal-bg hidden" style="z-index:2100">
    <div class="modal" style="max-width:380px">
      <h2>Entrar como Aluno</h2>
      <p class="subtitle">Acesse seu treino com CPF (11 d√≠gitos) + Data de Nascimento.</p>
      <form id="form-student-login">
        <div class="field"><label>CPF (somente n√∫meros)</label>
          <input id="stu-cpf" maxlength="11" placeholder="Somente n√∫meros" required inputmode="numeric"></div>
        <div class="field"><label>Data de nascimento</label>
          <input id="stu-birth" type="date" required></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn primary" type="submit">Entrar</button>
          <button class="btn ghost" type="button" id="btn-stu-login-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

</main>

<!-- ===================== JS √öNICO (Firebase + App) ===================== -->
<script type="module">
/* --------------- Firebase Imports --------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword,
  createUserWithEmailAndPassword, sendPasswordResetEmail,
  GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import {
  getFirestore, collection, doc, addDoc, getDoc, getDocs,
  updateDoc, deleteDoc, query, where, setDoc, serverTimestamp,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

/* --------------- CONFIG DO SEU PROJETO --------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBsPf40matUV8So60OHb0h4oRwMRWaB0ho",
  authDomain: "acdm-70082.firebaseapp.com",
  projectId: "acdm-70082",
  storageBucket: "acdm-70082.firebasestorage.app",
  messagingSenderId: "236961358499",
  appId: "1:236961358499:web:40b7391c4c9b3405ff1516",
  measurementId: "G-BR85P1C0X8"
};
/* -------------- FIM CONFIG -------------- */

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* --------------- Helpers UI --------------- */
const $ = (id)=>document.getElementById(id);
const $$=(sel)=>Array.from(document.querySelectorAll(sel));
const alertBox = $("alert");
function showAlert(msg, ok=false, ms = ok ? 1800 : 3500){
  if(!alertBox){ alert(msg); return; }
  alertBox.innerText = msg;
  alertBox.classList.remove("hidden","ok");
  if (ok) alertBox.classList.add("ok");
  alertBox.style.display = "block";
  clearTimeout(showAlert._t);
  showAlert._t = setTimeout(()=> alertBox.style.display = "none", ms);
}
function hideAlert(){ if(alertBox) alertBox.style.display = "none"; }
function show(el){ el?.classList?.remove("hidden"); }
function hide(el){ el?.classList?.add("hidden"); }

/* --------------- Estado Global --------------- */
let isStudentMode = false;
let currentUser   = null;             // personal
let currentPlan   = { plan:"free", limit:5 };
let studentsCache = [];               // alunos do personal

let unsubStudents = null, unsubCycles = null, unsubDays = null, unsubEx = null;

let currentStudent = null;            // {id, ...}
let currentCycle   = null;
let currentDay     = null;

/* --------------- Views / Navega√ß√£o --------------- */
const VIEWS = ["auth-card","app","train-view","days-view","ex-view","week-view"];
let currentView = "auth-card";

function applySecurityView(){
  if(isStudentMode){
    hide($("btn-add")); hide($("plan-pill")); hide($("user-pill"));
    hide($("btn-new-cycle")); hide($("btn-new-ex"));
  }else{
    show($("btn-add")); show($("plan-pill")); show($("user-pill"));
    show($("btn-new-cycle")); show($("btn-new-ex"));
  }
}
function goTo(viewId){
  VIEWS.forEach(id => $(id)?.classList.add("hidden"));
  $(viewId)?.classList.remove("hidden");
  currentView = viewId;
  applySecurityView();
}

/* --------------- AUTH STATE (Personal) --------------- */
onAuthStateChanged(auth, async (user)=>{
  if(user && !isStudentMode){
    currentUser = user;
    $("user-pill").innerText = user.email || "Personal";
    await ensureUserDoc();
    await startStudentsSnapshot();
    goTo("app");
  }else{
    if(!isStudentMode){
      resetRealtime(); resetContext();
      currentUser = null;
      goTo("auth-card");
    }
  }
});

async function ensureUserDoc(){
  if(!auth.currentUser) return;
  const uref = doc(db,"users",auth.currentUser.uid);
  const usnap = await getDoc(uref);
  if(!usnap.exists()){
    await setDoc(uref,{ plan:"free", limit:5, email:auth.currentUser.email||"", createdAt:serverTimestamp() },{merge:true});
    currentPlan = { plan:"free", limit:5 };
  }else{
    currentPlan = usnap.data() || { plan:"free", limit:5 };
  }
  $("plan-pill").innerText = currentPlan.plan === "pro" ? "Plano: PRO (ilimitado)" : `Plano: Free (${currentPlan.limit||5})`;
}

/* --------------- Login / Signup / Reset --------------- */
$("form-login")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  try{
    await signInWithEmailAndPassword(auth, $("login-email").value.trim(), $("login-pass").value);
    hideAlert();
  }catch(err){ showAlert("Erro ao entrar: "+err.message); }
});
$("btn-google")?.addEventListener("click", async ()=>{
  try{ await signInWithPopup(auth, new GoogleAuthProvider()); }
  catch(err){ showAlert("Erro: "+err.message); }
});

$("go-signup")?.addEventListener("click", ()=>{
  hide($("form-login")); hide($("btn-google"));
  show($("form-signup")); show($("go-login"));
  hide($("go-signup"));   show($("go-reset"));
  $("view-title").innerText="Criar conta";
  $("view-sub").innerText="Cadastre-se para atender seus alunos.";
  hideAlert();
});
$("go-login")?.addEventListener("click", ()=>{
  show($("form-login")); show($("btn-google"));
  hide($("form-signup")); hide($("form-reset")); hide($("go-login"));
  show($("go-signup"));   show($("go-reset"));
  $("view-title").innerText="Entrar";
  $("view-sub").innerText="Gerencie seus alunos facilmente.";
  hideAlert();
});
$("go-reset")?.addEventListener("click", ()=>{
  hide($("form-login")); hide($("form-signup")); hide($("btn-google"));
  show($("form-reset")); show($("go-login"));
  hide($("go-reset"));   hide($("go-signup"));
  $("view-title").innerText="Recuperar Senha";
  $("view-sub").innerText="Informe seu email cadastrado.";
  hideAlert();
});
$("form-signup")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  try{
    await createUserWithEmailAndPassword(auth, $("su-email").value.trim(), $("su-pass").value);
    showAlert("Conta criada com sucesso!", true);
    $("go-login").click();
  }catch(err){ showAlert(err.message); }
});
$("form-reset")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  try{
    await sendPasswordResetEmail(auth, $("rs-email").value.trim());
    showAlert("Email enviado!", true);
    $("go-login").click();
  }catch(err){ showAlert(err.message); }
});
$("btn-logout")?.addEventListener("click", async ()=>{
  isStudentMode = false;
  await signOut(auth).catch(()=>{});
  resetRealtime(); resetContext();
  goTo("auth-card");
  showAlert("Voc√™ saiu ‚úÖ", true);
});

/* --------------- Lista de Alunos (Personal) --------------- */
async function startStudentsSnapshot(){
  if(!auth.currentUser) return;
  unsubStudents?.();
  const qOwner = query(collection(db,"students"), where("ownerId","==", auth.currentUser.uid));
  unsubStudents = onSnapshot(qOwner, (snap)=>{
    const arr = [];
    snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
    arr.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    studentsCache = arr;
    renderStudents();
  });
}
$("search")?.addEventListener("input", renderStudents);

function onlyDigits(s){ return (s||"").replace(/\D/g,""); }
function isCpf11(s){ return /^\d{11}$/.test(onlyDigits(s)); }

function studentCardHTML(st){
  return `
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
      <strong>${st.name||"(Sem nome)"}</strong>
      <span class="badge">${st.level||"‚Äî"}</span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="badge">üéØ ${st.goal||"‚Äî"}</span>
      ${st.phone
        ? `<a class="btn-sm brand" style="margin-left:auto" href="https://wa.me/55${onlyDigits(st.phone)}" target="_blank" rel="noopener">WhatsApp</a>`
        : `<span class="badge" style="margin-left:auto">Sem telefone</span>`}
    </div>
    ${st.notes ? `<div class="badge" style="white-space:pre-wrap">üìù ${st.notes}</div>` : ""}
    <div class="actions">
      <button class="btn-sm brand" data-train>Treinos</button>
      <button class="btn-sm" data-edit>Editar</button>
      <button class="btn-sm danger" data-del>Excluir</button>
    </div>
  `;
}

function renderStudents(){
  const term = ($("search")?.value||"").toLowerCase();
  $("students-list").innerHTML = "";
  studentsCache
    .filter(s => (s.name||"").toLowerCase().includes(term))
    .forEach(st=>{
      const card = document.createElement("div");
      card.className = "card-student";
      card.innerHTML = studentCardHTML(st);
      card.querySelector("[data-train]").onclick = ()=> openTrainView(st);
      card.querySelector("[data-edit]").onclick  = ()=> openStudentModal(st);
      card.querySelector("[data-del]").onclick   = ()=> deleteStudent(st);
      $("students-list").appendChild(card);
    });
}

/* Novo aluno */
$("btn-add")?.addEventListener("click", ()=>{
  if((currentPlan.plan||"free")!=="pro" && studentsCache.length >= (currentPlan.limit||5)){
    showAlert("Limite do Plano Free atingido. Atualize para PRO para cadastrar mais alunos.");
    return;
  }
  $("modal-title").innerText = "Novo Aluno";
  $("form-student").reset();
  $("modal-bg").classList.remove("hidden");
});
$("btn-cancel")?.addEventListener("click", ()=> $("modal-bg").classList.add("hidden"));

/* Editar Aluno */
function openStudentModal(st){
  $("modal-title").innerText = "Editar Aluno";
  $("st-name").value  = st.name  || "";
  $("st-phone").value = st.phone || "";
  $("st-cpf").value   = st.id    || st.cpf || ""; // ID √© o CPF neste modelo
  $("st-birth").value = st.birth || "";
  $("st-goal").value  = st.goal  || "Hipertrofia";
  $("st-level").value = st.level || "Iniciante";
  $("st-notes").value = st.notes || "";
  $("modal-bg").classList.remove("hidden");
}

/* Salvar Aluno (ID = CPF) */
$("form-student").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const cpf = onlyDigits($("st-cpf").value);
  const payload = {
    ownerId: auth.currentUser?.uid || null,
    name: ($("st-name").value||"").trim(),
    phone: onlyDigits($("st-phone").value),
    cpf,
    birth: $("st-birth").value,
    goal:  $("st-goal").value,
    level: $("st-level").value,
    notes: ($("st-notes").value||"").trim(),
    updatedAt: serverTimestamp(),
  };
  if(!payload.name) return showAlert("Nome obrigat√≥rio!");
  if(!isCpf11(cpf)) return showAlert("CPF deve ter 11 d√≠gitos!");
  if(!payload.birth) return showAlert("Selecione a data de nascimento!");

  try{
    const ref = doc(db,"students", cpf);
    const snap= await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, { ...payload, createdAt: serverTimestamp() });
      showAlert("Aluno cadastrado ‚úÖ", true);
    }else{
      await setDoc(ref, payload, { merge:true });
      showAlert("Aluno atualizado ‚úÖ", true);
    }
    $("modal-bg").classList.add("hidden");
  }catch(err){ showAlert("Erro ao salvar: "+err.message); }
});

/* Excluir Aluno */
async function deleteStudent(st){
  if(!confirm(`Excluir ${st.name}?`)) return;
  try{
    await deleteDoc(doc(db,"students", st.id || st.cpf));
    showAlert("Aluno removido ‚úÖ", true);
  }catch(err){ showAlert("Erro ao excluir: "+err.message); }
}

/* --------------- Ciclos --------------- */
function openTrainView(st){
  if(isStudentMode) return;
  currentStudent = st;
  $("train-title").innerText = `${st.name} ‚Äî Treinos`;
  goTo("train-view");
  startCyclesSnapshot();
}
$("btn-new-cycle")?.addEventListener("click", ()=>{
  if(isStudentMode || !currentStudent) return;
  $("cycle-title").innerText = "Novo Ciclo";
  $("cycle-id").value = "";
  $("form-cycle").reset();
  $("cycle-bg").classList.remove("hidden");
});
$("btn-cycle-cancel")?.addEventListener("click", ()=> $("cycle-bg").classList.add("hidden"));

function cycleHTML(c){
  const period = (c.start && c.end)
    ? `üìÖ ${formatDate(c.start)} ‚Äî ${formatDate(c.end)}`
    : "üìÖ Sem per√≠odo";
  return `
    <strong>${c.name||"Sem nome"}</strong>
    <small>${period}</small>
    <div class="actions" style="margin-top:8px">
      <button class="btn-sm brand" data-open>Dias</button>
      ${isStudentMode ? "" : `
      <button class="btn-sm" data-edit>Editar</button>
      <button class="btn-sm danger" data-del>Excluir</button>`}
    </div>
  `;
}
let cyclesCache = [];
function renderCycles(list){
  const wrap = $("cycles-list");
  const empty = $("cycles-empty");
  if(!list.length){ show(empty); hide(wrap); return; }
  hide(empty); show(wrap);
  wrap.innerHTML = "";
  list.forEach(c=>{
    const div = document.createElement("div");
    div.className="card-student";
    div.innerHTML = cycleHTML(c);
    div.querySelector("[data-open]").onclick = ()=> openDays(c);
    if(!isStudentMode){
      div.querySelector("[data-edit]").onclick = ()=> openCycleModal(c);
      div.querySelector("[data-del]").onclick = ()=> deleteCycle(c);
    }
    wrap.appendChild(div);
  });
}
let unsubCyclesFn = null;
async function startCyclesSnapshot(){
  if(!currentStudent) return;
  const ref = collection(db,"students", currentStudent.id || currentStudent.cpf, "cycles");
  unsubCyclesFn?.(); unsubCyclesFn = onSnapshot(ref, snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
    arr.sort((a,b)=> (a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
    cyclesCache = arr;
    renderCycles(arr);
  });
}
function openCycleModal(c){
  $("cycle-title").innerText = "Editar Ciclo";
  $("cycle-id").value   = c.id;
  $("cycle-name").value = c.name || "";
  $("cycle-start").value= c.start || "";
  $("cycle-end").value  = c.end || "";
  $("cycle-bg").classList.remove("hidden");
}
$("form-cycle")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(isStudentMode || !currentStudent) return;
  const payload = {
    name: $("cycle-name").value.trim(),
    start: $("cycle-start").value || null,
    end:   $("cycle-end").value   || null,
    updatedAt: serverTimestamp()
  };
  if(!payload.name) return showAlert("Nome obrigat√≥rio!");
  const sid = currentStudent.id || currentStudent.cpf;
  const id  = $("cycle-id").value;
  const cref= id ? doc(db,"students",sid,"cycles",id) : doc(db,"students",sid,"cycles",crypto.randomUUID());
  try{
    if(!id) payload.createdAt = serverTimestamp();
    await setDoc(cref, payload, { merge:true });
    $("cycle-bg").classList.add("hidden");
  }catch(err){ showAlert("Erro ao salvar ciclo: "+err.message); }
});
async function deleteCycle(c){
  if(!confirm(`Excluir ciclo "${c.name}"?`)) return;
  try{
    await deleteDoc(doc(db,"students", currentStudent.id || currentStudent.cpf, "cycles", c.id));
    showAlert("Ciclo removido ‚úÖ", true);
  }catch(err){ showAlert("Erro: "+err.message); }
}

/* --------------- Dias --------------- */
let unsubDaysFn = null;
function openDays(cycle){
  currentCycle = cycle;
  $("days-title").innerText = `${cycle.name}`;
  goTo("days-view");
  startDaysSnapshot();
}
function startDaysSnapshot(){
  if(!currentStudent || !currentCycle) return;
  const ref = collection(db, "students", currentStudent.id || currentStudent.cpf, "cycles", currentCycle.id, "days");
  unsubDaysFn?.(); unsubDaysFn = onSnapshot(ref, snap=>{
    const arr=[]; snap.forEach(d=> arr.push({id:d.id, ...d.data()}));
    arr.sort((a,b)=>(a.order||0)-(b.order||0));
    renderDays(arr);
  });
}
function dayHTML(d){
  return `
    <div class="day-top"><span>${d.name}</span><span>${d.exercisesCount || 0} ex.</span></div>
    <div class="day-actions"><button class="btn-sm brand" data-open>Ver exerc√≠cios</button></div>
  `;
}
function renderDays(list){
  const wrap = $("days-grid"), empty = $("days-empty");
  if(!list.length){ show(empty); hide(wrap); return; }
  hide(empty); show(wrap);
  wrap.innerHTML = "";
  list.forEach(day=>{
    const el = document.createElement("div");
    el.className="day-card";
    el.innerHTML = dayHTML(day);
    el.querySelector("[data-open]").onclick = ()=> openExercises(day);
    wrap.appendChild(el);
  });
}
$("btn-regen-days")?.addEventListener("click", ensure7Days);
async function ensure7Days(){
  if(!currentCycle) return;
  const DAYS = [
    {id:"seg", name:"SEGUNDA", order:1},
    {id:"ter", name:"TER√áA", order:2},
    {id:"qua", name:"QUARTA", order:3},
    {id:"qui", name:"QUINTA", order:4},
    {id:"sex", name:"SEXTA", order:5},
    {id:"sab", name:"S√ÅBADO", order:6},
    {id:"dom", name:"DOMINGO", order:7},
  ];
  const ref = collection(db,"students", currentStudent.id || currentStudent.cpf, "cycles", currentCycle.id, "days");
  const existing = await getDocs(ref);
  const ids={}; existing.forEach(d=> ids[d.id]=true);
  for(const d of DAYS){
    if(!ids[d.id]){
      await setDoc(doc(ref,d.id), {
        name:d.name, order:d.order, exercisesCount:0, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      });
    }
  }
  showAlert("Dias recriados ‚úÖ", true);
}

/* --------------- Exerc√≠cios --------------- */
let unsubExFn = null;
function openExercises(day){
  currentDay = day;
  $("ex-title").innerText = `${currentCycle.name} ‚Äî ${day.name}`;
  goTo("ex-view");
  subscribeExercises();
}
function subscribeExercises(){
  if(!currentStudent || !currentCycle || !currentDay) return;
  const ref = collection(
    db, "students", currentStudent.id || currentStudent.cpf,
    "cycles", currentCycle.id, "days", currentDay.id, "exercises"
  );
  unsubExFn?.(); unsubExFn = onSnapshot(ref, snap=>{
    const arr=[]; snap.forEach(d=> arr.push({id:d.id, ...d.data()}));
    arr.sort((a,b)=> (a.order||0)-(b.order||0));
    renderExercises(arr);
    updateDoc(doc(db, "students", currentStudent.id || currentStudent.cpf, "cycles", currentCycle.id, "days", currentDay.id), {
      exercisesCount: arr.length, updatedAt: serverTimestamp()
    }).catch(()=>{});
  });
}
$("btn-new-ex")?.addEventListener("click", ()=>{
  if(isStudentMode) return showAlert("Aluno n√£o pode editar!");
  $("ex-id").value = "";
  $("ex-modal-title").innerText="Novo Exerc√≠cio";
  $("form-ex").reset();
  $("ex-bg").classList.remove("hidden");
});
$("btn-ex-cancel")?.addEventListener("click", ()=> $("ex-bg").classList.add("hidden"));
$("form-ex")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(isStudentMode) return;
  const id = $("ex-id").value;
  const data = {
    name: $("ex-name").value.trim(),
    sets: $("ex-sets").value.trim(),
    reps: $("ex-reps").value.trim(),
    load: $("ex-load").value.trim(),
    rest: $("ex-rest").value.trim(),
    notes: $("ex-notes").value.trim(),
    updatedAt: serverTimestamp()
  };
  if(!data.name) return showAlert("Informe o nome do exerc√≠cio.");
  const ref = collection(
    db, "students", currentStudent.id || currentStudent.cpf,
    "cycles", currentCycle.id, "days", currentDay.id, "exercises"
  );
  try{
    if(id){
      await updateDoc(doc(ref,id), data);
      showAlert("Exerc√≠cio atualizado ‚úÖ", true);
    }else{
      const snap = await getDocs(ref);
      const order = snap.size + 1;
      await addDoc(ref, { ...data, order, createdAt: serverTimestamp() });
      showAlert("Exerc√≠cio adicionado ‚úÖ", true);
    }
    $("ex-bg").classList.add("hidden");
  }catch(err){ showAlert("Erro: "+err.message); }
});
function exHTML(e){
  return `
    <div class="ex-card">
      <div class="ex-top">
        <div class="ex-name">${e.name}</div>
        ${!isStudentMode ? `
        <div class="ex-actions">
          <button class="btn-xs" data-edit>‚úèÔ∏è</button>
          <button class="btn-xs danger" data-del>üóë</button>
        </div>` : ""}
      </div>
      <div class="ex-line">
        <span class="ex-chip"><b>${e.sets||"‚Äî"}</b> s√©ries</span>
        <span class="ex-chip">${e.reps||"‚Äî"} reps</span>
        <span class="ex-chip">${e.load||"‚Äî"}</span>
        <span class="ex-chip">${e.rest||"‚Äî"}</span>
      </div>
      ${e.notes ? `<div class="ex-line" style="color:var(--sub)">Obs: ${e.notes}</div>` : ""}
    </div>
  `;
}
function renderExercises(list){
  const wrap = $("ex-list");
  wrap.innerHTML = "";
  if(!list.length){ show($("ex-empty")); return; }
  hide($("ex-empty"));
  list.forEach(e=>{
    const card = document.createElement("div");
    card.innerHTML = exHTML(e);
    if(!isStudentMode){
      card.querySelector("[data-edit]").onclick = ()=>{
        $("ex-id").value = e.id;
        $("ex-modal-title").innerText="Editar Exerc√≠cio";
        $("ex-name").value=e.name||"";
        $("ex-sets").value=e.sets||"";
        $("ex-reps").value=e.reps||"";
        $("ex-load").value=e.load||"";
        $("ex-rest").value=e.rest||"";
        $("ex-notes").value=e.notes||"";
        $("ex-bg").classList.remove("hidden");
      };
      card.querySelector("[data-del]").onclick = async()=>{
        if(confirm("Excluir exerc√≠cio?")){
          await deleteDoc(doc(
            db, "students", currentStudent.id || currentStudent.cpf,
            "cycles", currentCycle.id, "days", currentDay.id, "exercises", e.id
          ));
        }
      };
    }
    wrap.appendChild(card);
  });
}

/* --------------- Modo Aluno: Treino da Semana --------------- */
const DAY_ORDER = ["seg","ter","qua","qui","sex","sab","dom"];
const DAY_LABEL = { seg:"SEGUNDA", ter:"TER√áA", qua:"QUARTA", qui:"QUINTA", sex:"SEXTA", sab:"S√ÅBADO", dom:"DOMINGO" };
function todayId(){ return ["dom","seg","ter","qua","qui","sex","sab"][new Date().getDay()]; }
function toDate(s){ if(!s) return null; const [y,m,d]=s.split("-").map(Number); return new Date(y,(m||1)-1,d||1); }
function formatDate(d){
  if(!d) return "";
  const t = typeof d === "string" ? new Date(d) : d.toDate?.() || null;
  if(!t) return "";
  return t.toLocaleDateString("pt-BR",{timeZone:"UTC"});
}
async function pickActiveCycle(studentId){
  const ref = collection(db,"students",studentId,"cycles");
  const snap = await getDocs(ref);
  if(snap.empty) return null;
  const cycles=[];
  snap.forEach(d=>{
    const c = { id:d.id, ...d.data() };
    c._start = toDate(c.start); c._end = toDate(c.end);
    c._created = c.createdAt?.seconds || 0;
    cycles.push(c);
  });
  const now=new Date();
  const covering = cycles.filter(c=> c._start && c._end && c._start<=now && now<=c._end)
                         .sort((a,b)=> (a._start?.getTime()||0) - (b._start?.getTime()||0));
  if(covering.length) return covering[0];
  cycles.sort((a,b)=> (b._start?.getTime()||0)-(a._start?.getTime()||0) || (b._created - a._created));
  return cycles[0];
}
async function fetchWeek(studentId, cycleId){
  const daysRef = collection(db,"students",studentId,"cycles",cycleId,"days");
  const dSnap = await getDocs(daysRef);
  const map={};
  dSnap.forEach(d=>{ map[d.id] = { id:d.id, ...d.data(), exercises:[] }; });
  for(const id of DAY_ORDER){
    if(!map[id]) map[id]={ id, name:DAY_LABEL[id], order:DAY_ORDER.indexOf(id)+1, exercises:[] };
    const exRef = collection(db,"students",studentId,"cycles",cycleId,"days",id,"exercises");
    const exSnap= await getDocs(exRef);
    const list=[]; exSnap.forEach(e=> list.push({id:e.id, ...e.data()}));
    list.sort((a,b)=> (a.order||0)-(b.order||0));
    map[id].exercises=list;
  }
  return map;
}
function renderWeek(map){
  const wrap = $("week-days");
  wrap.innerHTML = "";
  const today = todayId();
  for(const id of DAY_ORDER){
    const d = map[id];
    const box = document.createElement("div");
    box.className="day-box";
    box.dataset.day = id;
    const isToday = id===today;
    box.innerHTML = `
      <div class="day-top">
        <span>${DAY_LABEL[id]}</span>
        <span>${(d.exercises?.length||0)} exerc√≠cio(s)</span>
      </div>
      <div class="ex-list" style="${isToday?'':'display:none'}">
        ${
          (d.exercises?.length||0)
            ? d.exercises.map(e=>`
                <div>
                  <b>${e.name||"(Sem nome)"}</b>
                  ‚Äî S√©ries: ${e.sets||"‚Äî"} | Reps: ${e.reps||"‚Äî"} | Carga: ${e.load||"‚Äî"} | Desc: ${e.rest||"‚Äî"}
                  ${e.notes? `<div style="opacity:.75">Obs: ${e.notes}</div>`:""}
                </div>
              `).join("")
            : `<div style="opacity:.7">Sem exerc√≠cios cadastrados.</div>`
        }
      </div>
    `;
    box.addEventListener("click", (ev)=>{
      if(ev.target.closest("a,button")) return;
      const cont = box.querySelector(".ex-list");
      const open = cont.style.display !== "none";
      cont.style.display = open ? "none" : "block";
    });
    if(isToday){ box.style.borderColor="var(--brand)"; }
    wrap.appendChild(box);
  }
}
async function openWeekView(studentDoc){
  try{
    isStudentMode = true;
    currentStudent = studentDoc;
    const cycle = await pickActiveCycle(studentDoc.id || studentDoc.cpf);
    $("week-student-name").innerText = studentDoc.name || "Seu Treino";
    $("week-cycle").innerText =
      cycle ? (cycle.name || "Ciclo") + (cycle.start&&cycle.end ? ` (${formatDate(cycle.start)} ‚Äî ${formatDate(cycle.end)})` : "")
            : "Sem ciclo ativo";
    if(!cycle){
      goTo("week-view");
      $("week-days").innerHTML = `<div class="day-box"><div class="day-top"><span>Sem ciclo</span><span>0 ex.</span></div><div class="ex-list" style="display:block">Pe√ßa ao seu personal para cadastrar um ciclo.</div></div>`;
      return;
    }
    const week = await fetchWeek(studentDoc.id || studentDoc.cpf, cycle.id);
    goTo("week-view");
    renderWeek(week);
    showAlert("Bons treinos! üí™", true);
  }catch(err){
    console.error(err);
    showAlert("Erro ao carregar a semana: "+err.message);
  }
}

/* --------------- Login Aluno --------------- */
$("btn-open-student-login")?.addEventListener("click", ()=>{
  $("stu-cpf").value = "";
  $("stu-birth").value = "";
  $("student-login-bg").classList.remove("hidden");
});
$("btn-stu-login-cancel")?.addEventListener("click", ()=> $("student-login-bg").classList.add("hidden"));

$("form-student-login")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  let cpf = onlyDigits($("stu-cpf").value);
  let birth = $("stu-birth").value;
  if(cpf.length !== 11) return showAlert("CPF deve ter 11 n√∫meros!");
  if(!birth) return showAlert("Informe a data de nascimento!");

  try{
    // Aluno entra anonimamente (somente leitura)
    await signInAnonymously(auth).catch(()=>{});
    // Busca por ID (CPF) primeiro
    const ref = doc(db,"students", cpf);
    const snap= await getDoc(ref);
    if(snap.exists()){
      const st = { id:cpf, ...snap.data() };
      if(st.birth !== birth) return showAlert("Dados n√£o conferem. Verifique CPF e data.", false);
      $("student-login-bg").classList.add("hidden");
      await openWeekView(st);
      return;
    }
    // Fallback: query por cpf+birth (caso tenha migra√ß√£o)
    const q = query(collection(db,"students"), where("cpf","==",cpf), where("birth","==",birth));
    const qs= await getDocs(q);
    if(qs.empty) return showAlert("Aluno n√£o encontrado. Fale com seu personal!");
    if(qs.size > 1) return showAlert("CPF em mais de um cadastro. Fale com seu personal.");
    const st2 = { id:qs.docs[0].id, ...qs.docs[0].data() };
    $("student-login-bg").classList.add("hidden");
    await openWeekView(st2);
  }catch(err){
    showAlert("Erro: "+err.message);
  }
});

/* --------------- Navega√ß√£o --------------- */
function resetRealtime(){
  unsubStudents?.(); unsubStudents=null;
  unsubCycles?.();   unsubCycles=null;
  unsubDays?.();     unsubDays=null;
  unsubEx?.();       unsubEx=null;
}
function resetContext(){ currentStudent=null; currentCycle=null; currentDay=null; }

function navBack(){
  if(isStudentMode){
    if(currentView==="ex-view"){ goTo("days-view"); return; }
    if(currentView==="days-view" || currentView==="train-view"){ goTo("week-view"); return; }
    if(currentView==="week-view"){
      if(confirm("Deseja sair da √°rea do aluno?")){
        isStudentMode = false; resetRealtime(); resetContext(); goTo("auth-card");
      }
      return;
    }
    goTo("week-view");
  }else{
    if(currentView==="ex-view"){ goTo("days-view"); return; }
    if(currentView==="days-view"){ goTo("train-view"); return; }
    if(currentView==="train-view"){ goTo("app"); return; }
    goTo("app");
  }
}
$("btn-back")?.addEventListener("click", navBack);
$("btn-back-cycles")?.addEventListener("click", navBack);
$("btn-back-days")?.addEventListener("click", navBack);
$("btn-week-back")?.addEventListener("click", ()=>{
  if(!isStudentMode){ goTo("app"); return; }
  if(confirm("Quer sair da √°rea do aluno?")){
    isStudentMode=false; resetRealtime(); resetContext(); goTo("auth-card");
  }
});

/* --------------- UX --------------- */
$("login-email")?.setAttribute("placeholder","email@exemplo.com");
$("login-pass")?.setAttribute("placeholder","‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢");
$("su-pass")?.setAttribute("placeholder","m√≠nimo 6 d√≠gitos");

/* Enter -> pr√≥ximo campo */
$$("input").forEach(inp=>{
  inp.addEventListener("keypress",(ev)=>{
    if(ev.key==="Enter"){
      const form = inp.closest("form");
      if(form){
        ev.preventDefault();
        const focusable = [...form.querySelectorAll("input,button")];
        const idx = focusable.indexOf(inp);
        if(idx>=0 && idx<focusable.length-1) focusable[idx+1].focus();
      }
    }
  });
});
</script>

<!--
===============================
 üîí REGRAS FIRESTORE (COLE EM: Firestore Database > Regras)
===============================
‚ö†Ô∏è IMPORTANTE: Em app 100% client-side, n√£o √© poss√≠vel checar "CPF+Nascimento"
nas regras durante a leitura sem backend. A regra abaixo:

- ‚úÖ Personal (dono) l√™/escreve TUDO dos seus alunos
- ‚úÖ Aluno (an√¥nimo) consegue LER somente (para visualiza√ß√£o no app)
- ‚ùå Aluno N√ÉO consegue escrever/editar nada

Se quiser blindar 100% para que um an√¥nimo N√ÉO possa ler outros alunos
adivinhando CPF, √© necess√°rio backend (Cloud Functions) para emitir um "ticket"
de acesso por usu√°rio. Posso te mandar isso depois.

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // USERS (personais)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ALUNOS (ID = CPF)
    match /students/{studentId} {

      // Personal dono: l√™ e escreve
      allow read, write: if request.auth != null
        && request.auth.uid == resource.data.ownerId;

      // Aluno logado anonimamente: somente leitura
      allow read: if request.auth != null
        && request.auth.token.firebase.sign_in_provider == "anonymous";

      // NUNCA permitir escrita para an√¥nimo
      allow write: if false;
    }

    // Subcole√ß√µes (cycles/days/exercises)
    match /students/{studentId}/{sub=**}/{docId} {
      // Personal dono
      allow read, write: if request.auth != null
        && request.auth.uid == get(/databases/$(database)/documents/students/$(studentId)).data.ownerId;

      // Aluno an√¥nimo: somente leitura
      allow read: if request.auth != null
        && request.auth.token.firebase.sign_in_provider == "anonymous";
    }
  }
}
-->
</body>
</html>
