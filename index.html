<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MeuTreino PRO</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#fafafa; --panel:#ffffff; --border:#e6e6e6;
  --text:#111; --sub:#555; --muted:#f3f3f3;
  --brand:#009c3b; --brand-dark:#026a29; --danger:#e54848;
}

*{box-sizing:border-box}
body{
  margin:0;width:100%;height:100%;
  font-family:'Inter',sans-serif;
  background:var(--bg);color:var(--text);
}
.hidden{display:none!important}

/* LOGIN */
.wrap{
  min-height:100vh;display:flex;justify-content:center;align-items:center;
  padding:16px;
}
.card{
  width:100%;max-width:420px;background:var(--panel);
  border-radius:16px;border:1px solid var(--border);padding:26px;
}
.brand{
  display:flex;align-items:center;gap:12px;font-size:20px;font-weight:bold;
}
.brand-logo{
  width:40px;height:40px;background:var(--brand);
  display:flex;align-items:center;justify-content:center;
  border-radius:8px;color:#fff;font-size:22px;
}
.pro{color:var(--brand-dark);font-weight:700}
.title{font-size:20px;margin:12px 0 6px}
.subtitle{font-size:14px;color:var(--sub);margin-bottom:14px}

.field{display:flex;flex-direction:column;margin-bottom:14px}
input,select,textarea{
  padding:12px;border-radius:10px;font-size:15px;
  border:1px solid var(--border);background:var(--muted);
}

.btn{
  width:100%;padding:12px;margin-top:2px;border:none;border-radius:10px;
  font-weight:600;cursor:pointer;
}
.btn.primary{background:var(--brand);color:#fff}
.btn.google{background:#fff;border:1px solid #ccc;color:#333}
.btn.ghost{background:var(--panel);border:1px solid var(--border);color:var(--text)}

.linkbar{display:flex;justify-content:space-between;margin-top:10px}
.link{border:none;background:none;color:var(--brand-dark);font-size:14px;cursor:pointer}

/* ALERT */
.alert{
  display:none;padding:10px;font-size:14px;margin-bottom:12px;
  border-radius:8px;background:#ffd8d8;color:#8a0000;
}
.alert.ok{background:#daf5d8;color:#084d19}

/* APP BASE */
.app,.view{
  width:100%;max-width:1100px;margin:auto;padding:20px;
}
.topbar{
  display:grid;grid-template-columns:1fr auto auto;
  gap:12px;align-items:center;margin-bottom:18px;
}
.pill{
  padding:6px 12px;background:var(--muted);
  border-radius:12px;border:1px solid var(--border);font-size:14px;
}
.search{max-width:320px}

.grid{display:grid;gap:16px}
@media(min-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}

/* Alumno card */
.card-student{
  background:var(--panel);border:1px solid var(--border);border-radius:16px;
  padding:14px;display:flex;flex-direction:column;gap:10px;position:relative;
}
.train-top{
  position:absolute;top:12px;right:12px;
  padding:8px 10px;border-radius:999px;font-size:13px;cursor:pointer;
  background:var(--brand);color:#fff;border:none;
  display:flex;gap:6px;align-items:center;
}
.badge{
  background:var(--muted);
  padding:6px 10px;border-radius:999px;font-size:12px;color:var(--sub);
}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn-sm{
  padding:8px 10px;border-radius:8px;font-size:13px;cursor:pointer;
  border:1px solid var(--border);background:var(--muted);
}
.btn-sm.brand{background:var(--brand);color:#fff;border:none}
.btn-sm.danger{background:var(--danger);color:#fff;border:none}

/* Floating Button */
.fab{
  position:fixed;right:20px;bottom:20px;width:56px;height:56px;
  border-radius:50%;background:var(--brand);color:#fff;
  border:none;font-size:32px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
}
.fab:hover{background:var(--brand-dark)}
/* MODAIS */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:flex;align-items:center;justify-content:center;
  z-index:2000;
}
.modal{
  width:90%;max-width:460px;background:var(--panel);
  padding:22px;border-radius:16px;
  border:1px solid var(--border);
}
.modal h2{margin:0 0 14px}

/* HEADERS de VIEW */
.view-header{
  display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;
}
.back{
  border:none;background:var(--panel);border:1px solid var(--border);
  padding:10px 12px;border-radius:10px;cursor:pointer
}
.helper{
  background:var(--panel);border:1px dashed var(--border);
  border-radius:12px;padding:16px;color:var(--sub)
}

/* CICLOS */
.list{display:grid;gap:12px}
.card-cycle{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;padding:14px;
  display:flex;justify-content:space-between;align-items:center;
  gap:12px;flex-wrap:wrap;
}
.cycle-actions{display:flex;gap:8px;flex-wrap:wrap}

/* DIAS */
.days-grid{display:grid;gap:12px}
@media(min-width:720px){.days-grid{grid-template-columns:repeat(3,1fr)}}
@media(min-width:1024px){.days-grid{grid-template-columns:repeat(4,1fr)}}
.day-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;padding:14px;
  display:flex;flex-direction:column;gap:6px
}
.day-top{display:flex;justify-content:space-between;align-items:center}
.day-name{font-weight:700}
.day-count{font-size:12px;color:var(--sub)}
.day-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn-xs{
  padding:6px 8px;border-radius:8px;border:1px solid var(--border);
  background:var(--muted);font-size:12px;cursor:pointer
}
.btn-xs.brand{background:var(--brand);color:#fff;border:none}

/* EXERC√çCIOS */
.ex-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;padding:14px;
  display:flex;flex-direction:column;gap:8px
}
.ex-top{
  display:flex;justify-content:space-between;
  align-items:center;gap:8px;flex-wrap:wrap
}
.ex-name{font-weight:700}
.ex-line{
  display:flex;gap:8px;flex-wrap:wrap;
  font-size:14px;color:#222
}
.ex-chip{
  background:var(--muted);border:1px solid var(--border);
  padding:6px 10px;border-radius:999px
}
.ex-actions{display:flex;gap:8px;flex-wrap:wrap}

/* Linha divis√≥ria */
.hr{
  height:1px;width:100%;background:var(--border);
  margin:20px 0;
}
</style>
</head>
<body>

<main class="wrap">

  <!-- LOGIN -->
  <section id="auth-card" class="card">
    <div class="brand">
      <div class="brand-logo">üèãÔ∏è</div>
      MeuTreino <span class="pro">PRO</span>
    </div>
    <h2 class="title" id="view-title">Entrar</h2>
    <p class="subtitle" id="view-sub">Gerencie seus alunos facilmente.</p>

    <div id="alert" class="alert"></div>

    <form id="form-login">
      <div class="field">
        <label>Email</label>
        <input id="login-email" type="email" required/>
      </div>
      <div class="field">
        <label>Senha</label>
        <input id="login-pass" type="password" required/>
      </div>
      <button class="btn primary">Entrar</button>
    </form>

    <form id="form-signup" class="hidden">
      <div class="field"><label>Nome completo</label><input id="su-name" required/></div>
      <div class="field"><label>Email</label><input id="su-email" type="email" required/></div>
      <div class="field"><label>Senha (6+)</label><input id="su-pass" type="password" minlength="6" required/></div>
      <button class="btn primary">Criar conta</button>
    </form>

    <form id="form-reset" class="hidden">
      <div class="field">
        <label>Email cadastrado</label>
        <input id="rs-email" type="email" required/>
      </div>
      <button class="btn primary">Enviar link</button>
    </form>

    <div class="hr"></div>

    <button id="btn-google" class="btn google">Entrar com Google</button>

    <div class="linkbar">
      <button class="link" id="go-signup">Criar conta</button>
      <button class="link" id="go-reset">Esqueci a senha</button>
    </div>

    <div class="linkbar">
      <button class="link hidden" id="go-login">Voltar login</button>
    </div>
  </section>

  <!-- APP: MEUS ALUNOS -->
  <section id="app" class="app hidden">
    <div class="topbar">
      <strong>Meus Alunos</strong>
      <input id="search" class="search" type="text" placeholder="Pesquisar por nome..."/>
      <div class="tools" style="display:flex;align-items:center;gap:10px">
        <span class="pill" id="plan-pill">Plano: Free (5)</span>
        <span class="pill" id="user-pill">...</span>
        <button id="btn-logout" class="btn ghost" style="width:auto">Sair</button>
      </div>
    </div>

    <div id="students-list" class="grid"></div>

    <button id="btn-add" class="fab">+</button>
  </section>

  <!-- VIEW: TREINOS DO ALUNO (CICLOS) -->
  <section id="train-view" class="view hidden">
    <div class="view-header">
      <button id="btn-back" class="back">‚Üê Voltar</button>
      <h2 id="train-title" style="margin:0">Aluno ‚Äî Treinos</h2>
      <div class="cycle-bar">
        <button id="btn-new-cycle" class="btn ghost" style="width:auto">+ Criar Ciclo</button>
      </div>
    </div>

    <div id="cycles-empty" class="helper hidden">
      Nenhum ciclo encontrado. Clique em <b>+ Criar Ciclo</b> para come√ßar.
    </div>

    <div id="cycles-list" class="list"></div>
  </section>

  <!-- VIEW: DIAS DO CICLO -->
  <section id="days-view" class="view hidden">
    <div class="view-header">
      <button id="btn-back-cycles" class="back">‚Üê Voltar aos ciclos</button>
      <h2 id="days-title" style="margin:0">Ciclo ‚Äî Dias</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btn-regen-days" class="btn ghost" style="width:auto">Recriar 7 dias</button>
      </div>
    </div>

    <div id="days-empty" class="helper hidden">
      Nenhum dia encontrado. Clique em <b>Recriar 7 dias</b>.
    </div>

    <div id="days-grid" class="days-grid"></div>
  </section>

  <!-- VIEW: EXERC√çCIOS DO DIA -->
  <section id="ex-view" class="view hidden">
    <div class="view-header">
      <button id="btn-back-days" class="back">‚Üê Voltar aos dias</button>
      <h2 id="ex-title" style="margin:0">Dia ‚Äî Exerc√≠cios</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btn-new-ex" class="btn ghost" style="width:auto">+ Novo Exerc√≠cio</button>
      </div>
    </div>

    <div id="ex-empty" class="helper hidden">Nenhum exerc√≠cio cadastrado para este dia.</div>
    <div id="ex-list" class="list"></div>
  </section>

  <!-- MODAL: CADASTRAR / EDITAR ALUNO -->
  <div id="modal-bg" class="modal-bg hidden">
    <div class="modal">
      <h2 id="modal-title">Novo Aluno</h2>
      <form id="form-student">
        <input type="hidden" id="st-id"/>

        <div class="field">
          <label>Nome</label>
          <input id="st-name" required/>
        </div>

        <div class="field">
          <label>WhatsApp</label>
          <input id="st-phone" placeholder="(DDD) 9 9999-9999"/>
        </div>

        <div class="field">
          <label>Objetivo</label>
          <select id="st-goal">
            <option>Hipertrofia</option>
            <option>Emagrecimento</option>
            <option>Resist√™ncia</option>
          </select>
        </div>

        <div class="field">
          <label>N√≠vel</label>
          <select id="st-level">
            <option>Iniciante</option>
            <option>Intermedi√°rio</option>
            <option>Avan√ßado</option>
          </select>
        </div>

        <div class="field">
          <label>Observa√ß√µes</label>
          <textarea id="st-notes" rows="3" placeholder="Ex.: Les√µes, limita√ß√µes..."></textarea>
        </div>

        <button class="btn primary" type="submit">Salvar</button>
        <button class="btn ghost" type="button" id="btn-cancel">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- MODAL: CICLO -->
  <div id="cycle-bg" class="modal-bg hidden">
    <div class="modal">
      <h2 id="cycle-title">Criar Ciclo</h2>
      <form id="form-cycle">
        <input type="hidden" id="cycle-id"/>

        <div class="field">
          <label>Nome do Ciclo</label>
          <input id="cycle-name" placeholder="Ex.: Hipertrofia M√™s 1" required/>
        </div>

        <div class="field">
          <small class="subtitle">Per√≠odo (opcional)</small>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="field" style="flex:1;min-width:160px">
            <label>In√≠cio</label>
            <input id="cycle-start" type="date"/>
          </div>

          <div class="field" style="flex:1;min-width:160px">
            <label>Fim</label>
            <input id="cycle-end" type="date"/>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button class="btn primary" type="submit">Salvar Ciclo</button>
          <button class="btn ghost" type="button" id="btn-cycle-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
  <!-- MODAL: EXERC√çCIO -->
  <div id="ex-bg" class="modal-bg hidden">
    <div class="modal">
      <h2 id="ex-modal-title">Novo Exerc√≠cio</h2>
      <form id="form-ex">
        <input type="hidden" id="ex-id"/>

        <div class="field">
          <label>Nome</label>
          <input id="ex-name" required placeholder="Ex.: Supino Reto"/>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="field" style="flex:1;min-width:110px">
            <label>S√©ries</label>
            <input id="ex-sets" type="number" min="1" step="1" placeholder="4"/>
          </div>
          <div class="field" style="flex:1;min-width:110px">
            <label>Repeti√ß√µes</label>
            <input id="ex-reps" type="text" placeholder="10 ou 12-10-8"/>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="field" style="flex:1;min-width:110px">
            <label>Carga</label>
            <input id="ex-load" type="text" placeholder="30 kg"/>
          </div>
          <div class="field" style="flex:1;min-width:110px">
            <label>Descanso</label>
            <input id="ex-rest" type="text" placeholder="60 s"/>
          </div>
        </div>

        <div class="field">
          <label>Observa√ß√µes</label>
          <textarea id="ex-notes" rows="3" placeholder="Ex.: postura, amplitude..."></textarea>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" type="submit">Salvar</button>
          <button class="btn ghost" type="button" id="btn-ex-cancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

</main>

<!-- FIREBASE + L√ìGICA -->
<script type="module">
import { 
  initializeApp 
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";

import {
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  GoogleAuthProvider, signInWithPopup, signOut,
  updateProfile, sendPasswordResetEmail, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

import {
  getFirestore, collection, addDoc, onSnapshot, query, where,
  serverTimestamp, doc, deleteDoc, updateDoc, getDoc, setDoc,
  orderBy, getDocs
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

/* CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBsPf40matUV8So60OHb0h4oRwMRWaB0ho",
  authDomain: "acdm-70082.firebaseapp.com",
  projectId: "acdm-70082",
  storageBucket: "acdm-70082.firebasestorage.app",
  messagingSenderId: "236961358499",
  appId: "1:236961358499:web:40b7391c4c9b3405ff1516"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* HELPERS */
const $ = id => document.getElementById(id);

function showAlert(msg, ok=false){
  const box = $("alert");
  box.textContent = msg;
  box.style.display = "block";
  box.classList.toggle("ok", ok);
  clearTimeout(showAlert._t);
  showAlert._t = setTimeout(()=> box.style.display="none", ok?1800:3500);
}

const wa = phone => phone ? 
  `https://wa.me/55${phone.replace(/\D/g,"")}` : null;

/* Muda entre telas base */
function go(view){
  ["auth-card","app","train-view","days-view","ex-view"]
    .forEach(id => $(id).classList.add("hidden"));
  $(view).classList.remove("hidden");
}

/* Troca telas login/cadastro */
$("go-signup").onclick = ()=> switchView("signup");
$("go-reset").onclick  = ()=> switchView("reset");
$("go-login").onclick  = ()=> switchView("login");

function switchView(view){
  ["form-login","form-signup","form-reset"]
    .forEach(id => $(id).classList.add("hidden"));

  $("go-login").classList.remove("hidden");

  if(view==="signup"){
    $("form-signup").classList.remove("hidden");
    $("view-title").textContent="Criar conta";
    $("view-sub").textContent="Cadastre-se e comece!";
  }
  else if(view==="reset"){
    $("form-reset").classList.remove("hidden");
    $("view-title").textContent="Recuperar senha";
    $("view-sub").textContent="Receba um link no email";
  }
  else{
    $("form-login").classList.remove("hidden");
    $("view-title").textContent="Entrar";
    $("view-sub").textContent="Gerencie seus alunos facilmente.";
    $("go-login").classList.add("hidden");
  }
}
/* =========================
   AUTH: login / cadastro / reset / google / logout
   ========================= */
$("form-login").onsubmit = async(e)=>{
  e.preventDefault();
  try{
    await signInWithEmailAndPassword(
      auth, $("login-email").value, $("login-pass").value
    );
  }catch(err){
    showAlert("Erro: "+err.message);
  }
};

$("form-signup").onsubmit = async(e)=>{
  e.preventDefault();
  try{
    const cred = await createUserWithEmailAndPassword(
      auth, $("su-email").value, $("su-pass").value
    );
    await updateProfile(cred.user, { displayName: $("su-name").value });

    const uref = doc(db,"users",cred.user.uid);
    await setDoc(uref, {
      plan:"free", limit:5,
      name:$("su-name").value, email:cred.user.email,
      createdAt:serverTimestamp()
    });

    showAlert("Conta criada com sucesso!", true);
    switchView("login");
  }catch(err){
    showAlert("Erro: "+err.message);
  }
};

$("form-reset").onsubmit = async(e)=>{
  e.preventDefault();
  try{
    await sendPasswordResetEmail(auth, $("rs-email").value);
    showAlert("Email enviado!", true);
    switchView("login");
  }catch(err){
    showAlert(err.message);
  }
};

$("btn-google").onclick = async()=>{
  try{
    const cred = await signInWithPopup(auth, new GoogleAuthProvider());
    const ref = doc(db,"users",cred.user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, {
        plan:"free", limit:5,
        email:cred.user.email, name:cred.user.displayName||"",
        createdAt:serverTimestamp()
      });
    }
  }catch(err){
    showAlert("Erro: "+err.message);
  }
};

$("btn-logout").onclick = ()=> signOut(auth);

/* =========================
   STATE / SUBSCRIBES
   ========================= */
let unsubStudents = null;
let unsubCycles = null;
let unsubDays = null;
let unsubExercises = null;

let currentUser = null;
let currentPlan = { plan:"free", limit:5 };
let currentStudent = null;   // {id, ...}
let currentCycle = null;     // {id, ...}
let currentDay = null;       // {id, ...}

/* =========================
   RENDER: CARD do ALUNO
   ========================= */
function renderStudentCard(st){
  const div = document.createElement("div");
  div.className="card-student";
  div.innerHTML = `
    <button class="train-top" data-train><span>üèã</span> Treinos</button>
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
      <strong>${st.name}</strong>
      <span class="badge">${st.level||"‚Äî"}</span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="badge">üéØ ${st.goal||"‚Äî"}</span>
      ${st.phone ? `<a class="btn-sm brand" href="${wa(st.phone)}" target="_blank">WhatsApp</a>`
                  : `<span class="badge">Sem telefone</span>`}
    </div>
    ${st.notes ? `<div class="badge" style="white-space:pre-wrap">üìù ${st.notes}</div>` : ""}
    <div class="actions">
      <button class="btn-sm" data-edit>Editar</button>
      <button class="btn-sm danger" data-del>Excluir</button>
    </div>
  `;

  // Editar
  div.querySelector("[data-edit]").onclick = ()=>{
    $("modal-title").textContent="Editar Aluno";
    $("st-id").value = st.id;
    $("st-name").value = st.name || "";
    $("st-phone").value = st.phone || "";
    $("st-goal").value = st.goal || "Hipertrofia";
    $("st-level").value = st.level || "Iniciante";
    $("st-notes").value = st.notes || "";
    $("modal-bg").classList.remove("hidden");
  };

  // Excluir
  div.querySelector("[data-del]").onclick = async()=>{
    if(confirm(`Excluir ${st.name}?`)){
      await deleteDoc(doc(db,"students",st.id));
    }
  };

  // Abrir treinos
  div.querySelector("[data-train]").onclick = ()=>{
    openTrainView(st);
  };

  return div;
}

function renderStudents(list){
  const wrap = $("students-list");
  wrap.innerHTML = "";
  const term = ($("search").value||"").toLowerCase();
  list
    .filter(s=> (s.name||"").toLowerCase().includes(term))
    .forEach(s=> wrap.appendChild(renderStudentCard(s)));
}

/* =========================
   AUTH LISTENER
   ========================= */
onAuthStateChanged(auth, async(user)=>{
  if(user){
    currentUser = user;
    $("user-pill").textContent = user.displayName || user.email;

    // Plano
    const uref = doc(db,"users",user.uid);
    const usnap = await getDoc(uref);
    currentPlan = usnap.exists()? usnap.data() : { plan:"free", limit:5 };
    $("plan-pill").textContent = currentPlan.plan==="pro"
      ? "Plano: PRO (ilimitado)" : `Plano: Free (${currentPlan.limit})`;

    // Subscribe alunos do usu√°rio
    if(unsubStudents) unsubStudents();
    const q = query(collection(db,"students"), where("ownerId","==",user.uid));
    unsubStudents = onSnapshot(q, snap=>{
      const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      arr.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
      renderStudents(arr);
      onAuthStateChanged._count = arr.length;
    });

    go("app");
  }else{
    // Limpar subs
    if(unsubStudents) unsubStudents();
    if(unsubCycles) unsubCycles();
    if(unsubDays) unsubDays();
    if(unsubExercises) unsubExercises();

    currentUser = null;
    currentStudent = null;
    currentCycle = null;
    currentDay = null;

    go("auth-card");
  }
});

/* =========================
   SEARCH
   ========================= */
$("search").oninput = ()=>{
  const cards = Array.from(document.querySelectorAll(".card-student"));
  const term = ($("search").value||"").toLowerCase();
  cards.forEach(c=>{
    const name = (c.querySelector("strong")?.textContent||"").toLowerCase();
    c.style.display = name.includes(term) ? "" : "none";
  });
};

/* =========================
   MODAL ALUNO (novo/editar)
   ========================= */
$("btn-add").onclick = ()=>{
  const count = onAuthStateChanged._count || 0;
  if(currentPlan.plan!=="pro" && count >= (currentPlan.limit||5)){
    showAlert("Limite do Plano Free atingido. Atualize para PRO para cadastrar mais alunos.");
    return;
  }
  $("modal-title").textContent="Novo Aluno";
  $("st-id").value = "";
  $("form-student").reset();
  $("modal-bg").classList.remove("hidden");
};

$("btn-cancel").onclick = ()=> $("modal-bg").classList.add("hidden");

$("form-student").onsubmit = async(e)=>{
  e.preventDefault();
  const id = $("st-id").value;

  const payload = {
    ownerId: currentUser.uid,
    name: $("st-name").value.trim(),
    phone: $("st-phone").value.trim(),
    goal: $("st-goal").value,
    level: $("st-level").value,
    notes: $("st-notes").value.trim(),
    updatedAt: serverTimestamp(),
    createdAt: serverTimestamp()
  };

  try{
    if(id){
      const ref = doc(db,"students",id);
      delete payload.createdAt;
      await updateDoc(ref, payload);
      showAlert("Aluno atualizado ‚úÖ", true);
    }else{
      await addDoc(collection(db,"students"), payload);
      showAlert("Aluno cadastrado ‚úÖ", true);
    }
    $("modal-bg").classList.add("hidden");
  }catch(err){
    showAlert("Erro: "+err.message);
  }
};
/* =========================
   TREINOS DO ALUNO ‚Äî CICLOS
   ========================= */
$("btn-back").onclick = ()=>{
  currentStudent = null;
  if(unsubCycles) unsubCycles();
  go("app");
};

// Abrir modal novo ciclo
$("btn-new-cycle").onclick = ()=>{
  if(!currentStudent) return;
  $("cycle-title").textContent = "Criar Ciclo";
  $("cycle-id").value = "";
  $("form-cycle").reset();
  $("cycle-bg").classList.remove("hidden");
};

$("btn-cycle-cancel").onclick = ()=> $("cycle-bg").classList.add("hidden");

// Abre tela de treinos do aluno
function openTrainView(student){
  currentStudent = student;
  $("train-title").textContent = `${student.name} ‚Äî Treinos`;
  go("train-view");
  subscribeCycles(student.id);
}

// OUVINTE em ciclos
function subscribeCycles(studentId){
  if(unsubCycles) unsubCycles();

  const cyclesRef = collection(db, "students", studentId, "cycles");

  unsubCycles = onSnapshot(cyclesRef, snap=>{
    const arr=[];
    snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));

    arr.sort((a,b)=>{
      const as = (a.startDate||"");
      const bs = (b.startDate||"");
      if(as===bs) return (a.name||"").localeCompare(b.name||"");
      return as < bs ? -1 : 1;
    });

    renderCycles(arr);
  });
}

// Render cards de ciclos
function renderCycles(list){
  const empty = $("cycles-empty");
  const wrap = $("cycles-list");

  wrap.innerHTML = "";

  if(!list.length){
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");

  list.forEach(c=>{
    const card = document.createElement("div");
    card.className="card-cycle";

    const period = (c.startDate && c.endDate)
      ? formatPeriod(c.startDate, c.endDate)
      : "Sem per√≠odo";

    card.innerHTML = `
      <div style="min-width:220px">
        <strong>${c.name || "(Sem nome)"}</strong>
        <div class="badge" style="margin-top:6px">${period}</div>
      </div>
      <div class="cycle-actions">
        <button class="btn-sm" data-open>üìÖ Abrir dias</button>
        <button class="btn-sm" data-edit>‚úèÔ∏è Renomear/Per√≠odo</button>
        <button class="btn-sm danger" data-del>üóë Excluir</button>
      </div>
    `;

    // Abrir dias
    card.querySelector("[data-open]").onclick = ()=>{
      currentCycle = { id:c.id, ...c };
      openDaysView();
    };

    // Editar ciclo
    card.querySelector("[data-edit]").onclick = ()=>{
      $("cycle-title").textContent = "Editar Ciclo";
      $("cycle-id").value = c.id;
      $("cycle-name").value = c.name || "";
      $("cycle-start").value = c.startDate || "";
      $("cycle-end").value = c.endDate || "";
      $("cycle-bg").classList.remove("hidden");
    };

    // Excluir ciclo
    card.querySelector("[data-del]").onclick = async()=>{
      if(confirm(`Excluir ciclo "${c.name}"?`)){
        await deleteDoc(doc(db,"students",currentStudent.id,"cycles",c.id));
      }
    };

    wrap.appendChild(card);
  });
}

// Salvar ciclo (novo/editar)
$("form-cycle").onsubmit = async(e)=>{
  e.preventDefault();
  if(!currentStudent) return showAlert("Aluno inv√°lido.");

  const id = $("cycle-id").value;
  const data = {
    name: $("cycle-name").value.trim(),
    startDate: $("cycle-start").value || null,
    endDate: $("cycle-end").value || null,
    updatedAt: serverTimestamp()
  };

  try{
    const cyclesRef = collection(db, "students", currentStudent.id, "cycles");

    if(id){
      await updateDoc(doc(cyclesRef, id), data);
      showAlert("Ciclo atualizado ‚úÖ", true);
    }else{
      await addDoc(cyclesRef, { ...data, createdAt: serverTimestamp() });
      showAlert("Ciclo criado ‚úÖ", true);
    }

    $("cycle-bg").classList.add("hidden");
  }catch(err){
    showAlert("Erro: "+err.message);
  }
};
/* =========================
   DIAS DO CICLO (7 DIAS)
   ========================= */
$("btn-back-cycles").onclick = ()=>{
  currentCycle = null;
  if(unsubDays) unsubDays();
  go("train-view");
};

// Recriar os 7 dias padr√£o
$("btn-regen-days").onclick = async()=>{
  if(!currentCycle) return;
  await ensure7Days();
  showAlert("Dias verificados/criados ‚úÖ", true);
};

// Abre view de dias do ciclo atual
function openDaysView(){
  $("days-title").textContent = `${currentCycle.name || "Ciclo"} ‚Äî Dias`;
  go("days-view");
  subscribeDays(currentStudent.id, currentCycle.id);
}

// Ouvinte de dias do ciclo
function subscribeDays(studentId, cycleId){
  if(unsubDays) unsubDays();

  const ref = collection(
    db, "students", studentId, "cycles", cycleId, "days"
  );

  unsubDays = onSnapshot(ref, snap=>{
    const arr=[]; 
    snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));

    // Ordena por 'order'
    arr.sort((a,b)=>(a.order||0)-(b.order||0));

    renderDaysGrid(arr);

    if(!arr.length) $("days-empty").classList.remove("hidden");
    else $("days-empty").classList.add("hidden");
  });
}

// Garante que existam 7 dias padr√£o
async function ensure7Days(){
  const mapDays = [
    {id:"seg", name:"SEGUNDA", order:1},
    {id:"ter", name:"TER√áA",   order:2},
    {id:"qua", name:"QUARTA",  order:3},
    {id:"qui", name:"QUINTA",  order:4},
    {id:"sex", name:"SEXTA",   order:5},
    {id:"sab", name:"S√ÅBADO",  order:6},
    {id:"dom", name:"DOMINGO", order:7},
  ];

  const daysRef = collection(
    db, "students", currentStudent.id, "cycles", currentCycle.id, "days"
  );

  const snap = await getDocs(daysRef);
  const existing = {};
  snap.forEach(d=> existing[d.id] = true);

  // Cria os que faltam
  for(const d of mapDays){
    if(!existing[d.id]){
      await setDoc(doc(daysRef, d.id), {
        name: d.name,
        order: d.order,
        exercisesCount: 0,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
    }
  }
}

// Renderiza cards dos dias
function renderDaysGrid(days){
  const grid = $("days-grid");
  grid.innerHTML = "";

  days.forEach(d=>{
    const card = document.createElement("div");
    card.className="day-card";

    const count = d.exercisesCount || 0;

    card.innerHTML = `
      <div class="day-top">
        <div class="day-name">${d.name}</div>
        <div class="day-count">${count} exerc√≠cio(s)</div>
      </div>
      <div class="day-actions">
        <button class="btn-xs brand" data-open>Ver exerc√≠cios</button>
      </div>
    `;

    // Abre lista de exerc√≠cios do dia
    card.querySelector("[data-open]").onclick = ()=>{
      openExercisesView(d);  // define currentDay e navega
    };

    grid.appendChild(card);
  });
}
/* =========================
   EXERC√çCIOS DO DIA ‚Äî CRUD
   ========================= */
$("btn-back-days").onclick = ()=>{
  if(unsubExercises) unsubExercises();
  currentDay = null;
  go("days-view");
};

// Bot√£o + exerc√≠cio
$("btn-new-ex").onclick = ()=>{
  if(!currentDay) return;
  $("ex-modal-title").textContent = "Novo Exerc√≠cio";
  $("ex-id").value = "";
  $("form-ex").reset();
  $("ex-bg").classList.remove("hidden");
};

$("btn-ex-cancel").onclick = ()=> $("ex-bg").classList.add("hidden");

// Abre e escuta exerc√≠cios do dia
function openExercisesView(dayDoc){
  currentDay = dayDoc;
  $("ex-title").textContent = `${currentCycle.name || "Ciclo"} ‚Äî ${dayDoc.name}`;
  go("ex-view");
  subscribeExercises();
}

// Refer√™ncia base para exerc√≠cios
function exCollectionRef(){
  return collection(
    db,
    "students", currentStudent.id,
    "cycles", currentCycle.id,
    "days", currentDay.id,
    "exercises"
  );
}

// Listener exerc√≠cios
function subscribeExercises(){
  if(unsubExercises) unsubExercises();

  const ref = exCollectionRef();

  unsubExercises = onSnapshot(ref, snap=>{
    const arr=[];
    snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));

    arr.sort((a,b)=>(a.order||0)-(b.order||0));
    renderExercises(arr);

    // Atualiza contador no doc do dia ‚úÖ
    updateDoc(
      doc(
        db,
        "students", currentStudent.id,
        "cycles", currentCycle.id,
        "days", currentDay.id
      ),
      {
        exercisesCount: arr.length,
        updatedAt: serverTimestamp()
      }
    ).catch(()=>{});
  });
}

// Render cards de exerc√≠cio
function renderExercises(list){
  const empty = $("ex-empty");
  const wrap = $("ex-list");

  wrap.innerHTML = "";

  if(!list.length){
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");

  list.forEach(ex=>{
    const card = document.createElement("div");
    card.className="ex-card";

    card.innerHTML = `
      <div class="ex-top">
        <div class="ex-name">${ex.name || "(Sem nome)"}</div>
        <div class="ex-actions">
          <button class="btn-xs" data-edit>‚úèÔ∏è Editar</button>
          <button class="btn-xs danger" data-del>üóë Excluir</button>
        </div>
      </div>
      <div class="ex-line">
        <span class="ex-chip">S√©ries: <b>${ex.sets || "‚Äî"}</b></span>
        <span class="ex-chip">Reps: <b>${ex.reps || "‚Äî"}</b></span>
        <span class="ex-chip">Carga: <b>${ex.load || "‚Äî"}</b></span>
        <span class="ex-chip">Descanso: <b>${ex.rest || "‚Äî"}</b></span>
      </div>
      ${ex.notes
        ? `<div class="ex-line" style="color:var(--sub)">Obs: ${ex.notes}</div>`
        : ""
      }
    `;

    // Editar
    card.querySelector("[data-edit]").onclick = ()=>{
      $("ex-modal-title").textContent = "Editar Exerc√≠cio";
      $("ex-id").value = ex.id;
      $("ex-name").value = ex.name || "";
      $("ex-sets").value = ex.sets || "";
      $("ex-reps").value = ex.reps || "";
      $("ex-load").value = ex.load || "";
      $("ex-rest").value = ex.rest || "";
      $("ex-notes").value = ex.notes || "";
      $("ex-bg").classList.remove("hidden");
    };

    // Excluir
    card.querySelector("[data-del]").onclick = async()=>{
      if(confirm(`Excluir "${ex.name || 'exerc√≠cio'}"?`)){
        await deleteDoc(doc(exCollectionRef(), ex.id));
      }
    };

    wrap.appendChild(card);
  });
}

// Criar/editar exerc√≠cio
$("form-ex").onsubmit = async(e)=>{
  e.preventDefault();
  if(!currentDay) return showAlert("Dia inv√°lido.");

  const id = $("ex-id").value;

  const data = {
    name: $("ex-name").value.trim(),
    sets: Number($("ex-sets").value || 0) || null,
    reps: $("ex-reps").value.trim() || null,
    load: $("ex-load").value.trim() || null,
    rest: $("ex-rest").value.trim() || null,
    notes: $("ex-notes").value.trim() || null,
    updatedAt: serverTimestamp()
  };

  if(!data.name) return showAlert("Informe o nome do exerc√≠cio.");

  try{
    const ref = exCollectionRef();

    if(id){
      await updateDoc(doc(ref, id), data);
      showAlert("Exerc√≠cio atualizado ‚úÖ", true);
    }else{
      const snap = await getDocs(ref);
      const order = snap.size + 1;

      await addDoc(ref, {
        ...data,
        order,
        createdAt: serverTimestamp()
      });

      showAlert("Exerc√≠cio adicionado ‚úÖ", true);
    }

    $("ex-bg").classList.add("hidden");
  }catch(err){
    showAlert("Erro: "+err.message);
  }
};
/* =========================
   Utils
   ========================= */
function formatPeriod(yyyy1, yyyy2){
  const f = s=>{
    if(!s) return "";
    const [y,m,d] = s.split("-");
    if(!y||!m||!d) return s;
    return `${d}/${m}/${y}`;
  };
  return `${f(yyyy1)} ‚Äî ${f(yyyy2)}`;
}

/* ‚úÖ Removeu-se a fun√ß√£o duplicada openTrainView
   que ANTES estava vazia e quebrava o sistema!!! ‚úÖ */
</script>
</body>
</html>
